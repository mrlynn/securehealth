server {
    listen 80;
    server_name localhost;
    
    # Root path serves the main landing page
    location = / {
        root /var/www/html/public;
        try_files /index.html =404;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    
    # Static documentation HTML page
    location = /documentation.html {
        root /var/www/html/public;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    
    # Documentation routes - redirect to external docs
    location = /docs/index.html {
        return 301 https://docs.securehealth.dev;
    }
    
    # Simple HTML documentation alternative - redirect to external docs
    location = /docs/simple-docs.html {
        return 301 https://docs.securehealth.dev;
    }
    
    # Static documentation assets - redirect to external docs
    location ~ ^/docs/.*\.(js|css|json|md)$ {
        return 301 https://docs.securehealth.dev;
    }
    
    # Documentation routes - redirect to external docs
    location ~ ^/docs {
        return 301 https://docs.securehealth.dev;
    }
    
    # Help route
    location = /help {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # Demo app
    location = /demo-app/index.html {
        root /var/www/html/public;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    
    # Login page
    location = /login.html {
        root /var/www/html/public;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    
    # React Frontend Assets
    location ~ ^/static/ {
        root /var/www/html/frontend;
        expires 30d;
    }
    
    # API Login route - now handled by Symfony (removed debug.php override)
    # location = /api/login {
    #     root /var/www/html/public;
    #     fastcgi_pass php:9000;
    #     include fastcgi_params;
    #     fastcgi_param SCRIPT_FILENAME $document_root/debug.php;
    #     fastcgi_param DOCUMENT_ROOT $realpath_root;
    # }
    
    # API Health check route
    location = /api/health {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/api_health.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }

    # API Audit logs route
    location = /api_audit_logs.php {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/api_audit_logs.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # API Patients route - route through Symfony for authentication
    location = /api/patients {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index2.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # API Admin routes - route through Symfony for authentication
    location ~ ^/api/admin {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index2.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # API Single Patient route
    location ~ ^/api/patient/([^/]+)$ {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/api_mongo_patient.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param QUERY_STRING id=$1;
    }
    
    # API Raw Patient Document route
    location = /api_mongo_patient_raw.php {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/api_mongo_patient_raw.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # X-Ray API route - direct PHP file access
    location = /api_mongo_patient_xray.php {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/api_mongo_patient_xray.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # API routes
    location ~ ^/api {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index2.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }

    # Staff routes - route through Symfony
    location ~ ^/staff {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index2.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }

    # Debug endpoints
    location ~ \.php$ {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # HTML files in public directory
    location ~ \.html$ {
        root /var/www/html/public;
        try_files $uri =404;
    }

    # Assets for the docs (CSS, JS)
    location ~ ^/assets/ {
        root /var/www/html/public;
        try_files $uri =404;
    }

    # JavaScript files in public directory (for auth-fix.js and other static JS)
    location ~ \.js$ {
        root /var/www/html/public;
        try_files $uri =404;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    
    # Images directory specifically
    location /images/ {
        root /var/www/html/public;
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Static images and assets in public directory
    location ~ \.(png|jpg|jpeg|gif|ico|svg|css)$ {
        root /var/www/html/public;
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # API endpoints handled through main PHP application

    # Frontend app - handle all other routes
    location / {
        root /var/www/html/frontend;
        try_files $uri $uri/ /index.html;
    }

    error_log /var/log/nginx/project_error.log;
    access_log /var/log/nginx/project_access.log;
}