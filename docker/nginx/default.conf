server {
    listen 80;
    server_name localhost;
    
    # Root path redirects to login page
    location = / {
        return 301 $scheme://$host:8081/login.html;
    }
    
    # Demo app
    location = /demo-app/index.html {
        root /var/www/html/public;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    
    # Login page
    location = /login.html {
        root /var/www/html/public;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    
    # React Frontend Assets
    location ~ ^/static/ {
        root /var/www/html/frontend;
        expires 30d;
    }
    
    # API Login route - direct to debug.php
    location = /api/login {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/debug.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # API Health check route
    location = /api/health {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/api_health.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # API Patients route - route through Symfony for authentication (must come before general API route)
    location = /api/patients {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index2.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # X-Ray API route - direct PHP file access
    location = /api_mongo_patient_xray.php {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/api_mongo_patient_xray.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # API routes - general route for other API endpoints
    location ~ ^/api {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index2.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # API Single Patient route
    location ~ ^/api/patient/([^/]+)$ {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/api_mongo_patient.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param QUERY_STRING id=$1;
    }
    
    # Encrypted Search API routes
    location ~ ^/api/encrypted-search/(equality|range|complex|capabilities)$ {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/api_encrypted_search_$1.php;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }

    # Debug endpoints
    location ~ \.php$ {
        root /var/www/html/public;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
    }
    
    # HTML files in public directory
    location ~ \.html$ {
        root /var/www/html/public;
        try_files $uri =404;
    }

    # JavaScript files in public directory (for auth-fix.js and other static JS)
    location ~ \.js$ {
        root /var/www/html/public;
        try_files $uri =404;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # Images directory specifically
    location /images/ {
        root /var/www/html/public;
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Static images and assets in public directory
    location ~ \.(png|jpg|jpeg|gif|ico|svg|css)$ {
        root /var/www/html/public;
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Frontend app - handle all other routes
    location / {
        root /var/www/html/public;
        try_files $uri $uri/ /index.html;
    }

    error_log /var/log/nginx/project_error.log;
    access_log /var/log/nginx/project_access.log;
}