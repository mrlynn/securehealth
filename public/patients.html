<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SecureHealth Patients</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .role-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .role-doctor { background-color: #dc3545; color: white; }
    .role-nurse { background-color: #0d6efd; color: white; }
    .role-receptionist { background-color: #6c757d; color: white; }
    .role-admin { background-color: #6f42c1; color: white; }
    .encryption-badge {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: 4px;
      vertical-align: middle;
    }
    .encryption-deterministic { background-color: #0dcaf0; color: #055160; }
    .encryption-range { background-color: #20c997; color: #0f5132; }
    .encryption-standard { background-color: #6f42c1; color: white; }
    .sensitive-field { background-color: #fff3cd; border-left: 3px solid #ffc107; padding: 8px; margin: 2px 0; }
    .medical-field { background-color: #d1ecf1; border-left: 3px solid #0dcaf0; padding: 8px; margin: 2px 0; }
    .insurance-field { background-color: #d4edda; border-left: 3px solid #28a745; padding: 8px; margin: 2px 0; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/index.html">SecureHealth</a>
            <div class="d-flex align-items-center gap-2 ms-auto">
              <span class="text-white-50" id="userName">Loading...</span>
              <span id="userRole" class="role-badge"></span>
              <a href="/admin.html" id="adminLink" class="btn btn-outline-light btn-sm" style="display: none;">
                <i class="fas fa-cog me-1"></i>Admin
              </a>
              <button id="logoutBtn" class="btn btn-outline-light btn-sm">Log out</button>
            </div>
    </div>
  </nav>

  <div class="container my-4">
    <div id="status" class="alert" style="display: none;"></div>
    
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Patient Records</h4>
        <div>
          <span id="roleInfo" class="text-muted small"></span>
          <a href="/patient-add.html" class="btn btn-primary btn-sm ms-2" id="addPatientBtn" style="display: none;">Add New Patient</a>
        </div>
      </div>
      <div class="card-body">
        <div id="patientsList">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading patients data...</p>
          </div>
        </div>
      </div>
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const userName = document.getElementById('userName');
      const userRole = document.getElementById('userRole');
      const roleInfo = document.getElementById('roleInfo');
      const addPatientBtn = document.getElementById('addPatientBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const patientsList = document.getElementById('patientsList');
      const statusDiv = document.getElementById('status');
      
      let currentUser = null;
      
      // Check authentication
      checkAuth();
      
      // Load patients
      loadPatients();
      
      // Event listeners
      logoutBtn.addEventListener('click', handleLogout);
      
      // Check if user is authenticated and determine role
      function checkAuth() {
        const storedUser = localStorage.getItem('securehealth_user');
        console.log("checkAuth - stored user:", storedUser);
        
        if (!storedUser) {
          console.log("No user found in localStorage, redirecting to login");
          window.location.href = '/login.html';
          return;
        }
        
        try {
          const user = JSON.parse(storedUser);
          console.log("User data parsed successfully:", user);
          console.log("User isAdmin flag:", user.isAdmin);
          currentUser = user;
          userName.textContent = user.username || user.email;
          
          // Determine user role based on email or username
          const userRoleType = determineUserRole(user);
          console.log("Determined user role:", userRoleType);
          userRole.textContent = userRoleType;
          userRole.className = `role-badge role-${userRoleType.toLowerCase()}`;
          
          // Set role-specific info and permissions
          setRoleInfo(userRoleType);
          
        } catch (e) {
          console.error("Error parsing user data:", e);
          window.location.href = '/login.html';
        }
      }
      
      // Determine user role based on email/username patterns
      function determineUserRole(user) {
        const email = (user.email || '').toLowerCase();
        const username = (user.username || '').toLowerCase();
        
        // Check for admin first
        if (user.isAdmin || email.includes('admin') || username.includes('admin')) {
          return 'ADMIN';
        } else if (email.includes('doctor') || username.includes('doctor')) {
          return 'DOCTOR';
        } else if (email.includes('nurse') || username.includes('nurse')) {
          return 'NURSE';
        } else if (email.includes('receptionist') || username.includes('receptionist')) {
          return 'RECEPTIONIST';
        }
        
        // Default fallback
        return 'RECEPTIONIST';
      }
      
      // Set role-specific information and permissions
          function setRoleInfo(role) {
            switch(role) {
              case 'DOCTOR':
                roleInfo.textContent = 'Full access to all patient data including SSN, medical history, and sensitive information';
                addPatientBtn.style.display = 'inline-block';
                break;
              case 'NURSE':
                roleInfo.textContent = 'Access to medical information but not SSN or insurance details';
                addPatientBtn.style.display = 'none';
                break;
              case 'RECEPTIONIST':
                roleInfo.textContent = 'Access to basic patient info and insurance details only';
                addPatientBtn.style.display = 'none';
                break;
              case 'ADMIN':
                roleInfo.textContent = 'Administrative access to basic patient info and insurance. No access to medical data or SSN.';
                addPatientBtn.style.display = 'none';
                break;
            }
            
            // Check for admin privileges and show admin link
            checkAdminStatus();
          }
          
          // Check for admin privileges and show admin link
          function checkAdminStatus() {
            const adminLink = document.getElementById('adminLink');
            console.log('checkAdminStatus - adminLink:', adminLink);
            console.log('checkAdminStatus - currentUser:', currentUser);
            console.log('checkAdminStatus - currentUser.isAdmin:', currentUser ? currentUser.isAdmin : 'no currentUser');
            console.log('checkAdminStatus - currentUser.roles:', currentUser ? currentUser.roles : 'no currentUser');
            
            // Check both isAdmin flag and ROLE_ADMIN in roles array
            const isAdminUser = currentUser && (currentUser.isAdmin === true || (currentUser.roles && currentUser.roles.includes('ROLE_ADMIN')));
            
            if (adminLink && isAdminUser) {
              console.log('Showing admin link - user is admin');
              adminLink.style.display = 'inline-block';
            } else {
              console.log('Hiding admin link - user is not admin');
              if (adminLink) {
                adminLink.style.display = 'none';
              }
            }
          }
      
      // Load patients data
      async function loadPatients() {
        try {
          console.log("Attempting to fetch patients data");
          
          // Get user data for debugging
          const userData = localStorage.getItem('securehealth_user');
          console.log("User data from localStorage:", userData);
          
          // First try a simpler API endpoint to test authentication
          console.log("Testing API connection...");
          const testResponse = await fetch('/api/health', {
            headers: {
              'Content-Type': 'application/json',
              // No auth header needed for health check
            },
            credentials: 'include'
          });
          
          console.log("Health check response:", testResponse.status);
          
          // Now try patients API
          const response = await fetch('/api/patients', {
            headers: {
              'Content-Type': 'application/json',
              // Add any authentication headers if needed
            },
            credentials: 'include'
          });
          
          console.log("Patients API response status:", response.status);
          
          if (response.status === 401) {
            // Unauthorized - redirect to login
            showStatus('Your session has expired. Please log in again.', 'info');
            console.log("Received 401 Unauthorized, will redirect to login");
            setTimeout(() => {
              window.location.href = '/login.html'; // Use the main login page
            }, 2000);
            return;
          }
          
          if (!response.ok) {
            throw new Error(`Failed to load patients: ${response.status} ${response.statusText}`);
          }
          
          const data = await response.json();
          
          console.log("API response data:", data);
          
          if (Array.isArray(data)) {
            renderPatients(data);
          } else if (data.error) {
            throw new Error(data.message || 'API error');
          } else {
            renderPatients([]);
            showStatus('No patients found or invalid data format', 'info');
          }
        } catch (error) {
          console.error("Failed to load data:", error);
          showStatus('Error loading patients data', 'error');
          renderEmptyTable();
        }
      }
      
      // Render patients table with role-based access
      function renderPatients(patients) {
        if (patients.length === 0) {
          patientsList.innerHTML = '<div class="text-center py-4"><p class="text-muted">No patients found.</p></div>';
          return;
        }
        
        const userRole = determineUserRole(currentUser);
        
        // Generate table headers based on role
        const headers = generateTableHeaders(userRole);
        
        let html = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  ${headers}
                </tr>
              </thead>
              <tbody>
        `;
        
        patients.forEach(patient => {
          html += generatePatientRow(patient, userRole);
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
        
        // Add role-based access explanation
        html += generateRoleExplanation(userRole);
        
        patientsList.innerHTML = html;
      }
      
      // Generate table headers based on user role
      function generateTableHeaders(role) {
        let headers = '<th>Name <span class="encryption-badge encryption-deterministic">D</span></th>';
        headers += '<th>DOB <span class="encryption-badge encryption-range">R</span></th>';
        headers += '<th>Email <span class="encryption-badge encryption-deterministic">D</span></th>';
        headers += '<th>Phone <span class="encryption-badge encryption-deterministic">D</span></th>';
        
        switch(role) {
          case 'DOCTOR':
            headers += '<th>SSN <span class="encryption-badge encryption-standard">S</span></th>';
            headers += '<th>Medical Info <span class="encryption-badge encryption-standard">S</span></th>';
            headers += '<th>Insurance <span class="encryption-badge encryption-standard">S</span></th>';
            break;
          case 'NURSE':
            headers += '<th>Medical Info <span class="encryption-badge encryption-standard">S</span></th>';
            break;
          case 'RECEPTIONIST':
            headers += '<th>Insurance <span class="encryption-badge encryption-standard">S</span></th>';
            break;
          case 'ADMIN':
            headers += '<th>Insurance <span class="encryption-badge encryption-standard">S</span></th>';
            break;
        }
        
        headers += '<th>Actions</th>';
        return headers;
      }
      
      // Generate patient row based on user role
      function generatePatientRow(patient, role) {
        let row = `
          <tr>
            <td><strong>${patient.firstName || ''} ${patient.lastName || ''}</strong></td>
            <td>${formatDate(patient.birthDate)}</td>
            <td>${patient.email || ''}</td>
            <td>${patient.phoneNumber || patient.phone || ''}</td>
        `;
        
        switch(role) {
          case 'DOCTOR':
            // Doctors see everything
            row += `<td class="sensitive-field">${patient.ssn || 'Not provided'}</td>`;
            row += `<td class="medical-field">
              <div><strong>Diagnosis:</strong> ${formatArray(patient.diagnosis)}</div>
              <div><strong>Medications:</strong> ${formatArray(patient.medications)}</div>
            </td>`;
            row += `<td class="insurance-field">
              <div><strong>Provider:</strong> ${patient.insuranceDetails?.provider || 'Not provided'}</div>
              <div><strong>Policy:</strong> ${patient.insuranceDetails?.policyNumber || 'Not provided'}</div>
            </td>`;
            break;
          case 'NURSE':
            // Nurses see medical info but not SSN
            row += `<td class="medical-field">
              <div><strong>Diagnosis:</strong> ${formatArray(patient.diagnosis)}</div>
              <div><strong>Medications:</strong> ${formatArray(patient.medications)}</div>
            </td>`;
            break;
          case 'RECEPTIONIST':
            // Receptionists see insurance but no medical data
            row += `<td class="insurance-field">
              <div><strong>Provider:</strong> ${patient.insuranceDetails?.provider || 'Not provided'}</div>
              <div><strong>Policy:</strong> ${patient.insuranceDetails?.policyNumber || 'Not provided'}</div>
            </td>`;
            break;
          case 'ADMIN':
            // Admins see insurance but no medical data or SSN
            row += `<td class="insurance-field">
              <div><strong>Provider:</strong> ${patient.insuranceDetails?.provider || 'Not provided'}</div>
              <div><strong>Policy:</strong> ${patient.insuranceDetails?.policyNumber || 'Not provided'}</div>
            </td>`;
            break;
        }
        
        // Actions based on role
        row += `<td>${generateActionButtons(patient, role)}</td>`;
        row += '</tr>';
        
        return row;
      }
      
      // Generate action buttons based on role
      function generateActionButtons(patient, role) {
        let buttons = `<button class="btn btn-sm btn-outline-primary" onclick="viewPatient('${patient.id}')">View</button>`;
        
        // Only doctors can edit/delete
        if (role === 'DOCTOR') {
          buttons += ` <button class="btn btn-sm btn-outline-secondary" onclick="editPatient('${patient.id}')">Edit</button>`;
          buttons += ` <button class="btn btn-sm btn-outline-danger" onclick="deletePatient('${patient.id}')">Delete</button>`;
        }
        // Admins cannot edit/delete patient records
        if (role === 'ADMIN') {
          buttons += ` <span class="text-muted small">View Only</span>`;
        }
        // X-Ray is visible to all roles for educational purposes
        buttons += ` <button class="btn btn-sm btn-warning" onclick="viewRaw('${patient.id}')">X-Ray</button>`;
        
        return buttons;
      }
      
      // Format array data for display
      function formatArray(arr) {
        if (!arr || !Array.isArray(arr) || arr.length === 0) {
          return 'None';
        }
        return arr.slice(0, 2).join(', ') + (arr.length > 2 ? ` (+${arr.length - 2} more)` : '');
      }
      
      // Generate role-based access explanation
      function generateRoleExplanation(role) {
        let explanation = `
          <div class="mt-4">
            <div class="card border-0 bg-light">
              <div class="card-body">
                <h6 class="card-title">Role-Based Access Control (RBAC) Demonstration</h6>
                <p class="card-text small mb-2">This system demonstrates HIPAA-compliant role-based access control using MongoDB Queryable Encryption:</p>
        `;
        
        switch(role) {
          case 'DOCTOR':
            explanation += `
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-success">✓ What you can see:</h6>
                    <ul class="small">
                      <li><strong>All patient data</strong> including SSN, medical history, medications</li>
                      <li><strong>Insurance information</strong> for billing purposes</li>
                      <li><strong>Full edit/delete permissions</strong> for patient records</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-info">Encryption types shown:</h6>
                    <ul class="small">
                      <li><span class="encryption-badge encryption-deterministic">D</span> Deterministic - Searchable fields</li>
                      <li><span class="encryption-badge encryption-range">R</span> Range - Date queries</li>
                      <li><span class="encryption-badge encryption-standard">S</span> Standard - Maximum security</li>
                    </ul>
                  </div>
                </div>
            `;
            break;
          case 'NURSE':
            explanation += `
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-success">✓ What you can see:</h6>
                    <ul class="small">
                      <li><strong>Medical information</strong> (diagnosis, medications)</li>
                      <li><strong>Basic patient data</strong> (name, DOB, contact info)</li>
                      <li><strong>View-only access</strong> to patient records</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-danger">✗ What you cannot see:</h6>
                    <ul class="small">
                      <li><strong>SSN</strong> - Not needed for medical care</li>
                      <li><strong>Insurance details</strong> - Handled by reception</li>
                      <li><strong>Edit/Delete permissions</strong> - Doctor-only actions</li>
                    </ul>
                  </div>
                </div>
            `;
            break;
          case 'RECEPTIONIST':
            explanation += `
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-success">✓ What you can see:</h6>
                    <ul class="small">
                      <li><strong>Insurance information</strong> for billing and scheduling</li>
                      <li><strong>Basic patient data</strong> (name, DOB, contact info)</li>
                      <li><strong>View-only access</strong> to patient records</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-danger">✗ What you cannot see:</h6>
                    <ul class="small">
                      <li><strong>Medical information</strong> - Not needed for scheduling</li>
                      <li><strong>SSN</strong> - Not needed for front desk operations</li>
                      <li><strong>Edit/Delete permissions</strong> - Doctor-only actions</li>
                    </ul>
                  </div>
                </div>
            `;
            break;
          case 'ADMIN':
            explanation += `
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-success">✓ What you can see:</h6>
                    <ul class="small">
                      <li><strong>Basic patient data</strong> (name, DOB, contact info)</li>
                      <li><strong>Insurance information</strong> for administrative purposes</li>
                      <li><strong>Audit logs and system monitoring</strong></li>
                      <li><strong>User management capabilities</strong></li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-danger">✗ What you cannot see:</h6>
                    <ul class="small">
                      <li><strong>Medical information</strong> - Not needed for administration</li>
                      <li><strong>SSN</strong> - Not needed for administrative tasks</li>
                      <li><strong>Edit/Delete patient records</strong> - Medical staff only</li>
                    </ul>
                  </div>
                </div>
            `;
            break;
        }
        
        explanation += `
                <div class="mt-3">
                  <p class="small text-muted mb-0">
                    <strong>Note:</strong> This demonstrates the "minimum necessary" rule of HIPAA - users only see the data they need for their job function. 
                    All sensitive data is encrypted using MongoDB Queryable Encryption, ensuring even database administrators cannot access patient information.
                  </p>
                </div>
              </div>
            </div>
          </div>
        `;
        
        return explanation;
      }
      
      // Render empty table
      function renderEmptyTable() {
        patientsList.innerHTML = `
          <div class="text-center py-4">
            <div class="alert alert-warning">
              <h5>Unable to load patients data</h5>
              <p class="mb-0">Please check your connection and try again.</p>
            </div>
          </div>
        `;
      }
      
      // Format date
      function formatDate(dateString) {
        if (!dateString) return '';
        
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString();
        } catch (e) {
          return dateString;
        }
      }
      
      // Logout function
      async function handleLogout() {
        console.log("Logging out, removing user from localStorage");
        
        // Call logout API to clear server session
        try {
          await fetch('/api/logout', {
            method: 'POST',
            credentials: 'include'
          });
        } catch (e) {
          console.log("Logout API call failed, continuing with client-side logout");
        }
        
        localStorage.removeItem('securehealth_user');
        window.location.href = '/login.html';
      }
      
      // Display status message
      function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
        statusDiv.style.display = 'block';
        
        // Auto-hide success/info messages after 5 seconds
        if (type === 'success' || type === 'info') {
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 5000);
        }
      }
    });
    
    // Patient action functions (declared in global scope for onclick handlers)
    function viewPatient(id) {
      console.log('Navigating to patient detail page for ID:', id);
      window.location.href = `/patient-detail.html?id=${id}`;
    }
    
    function editPatient(id) {
      console.log('Navigating to patient edit page for ID:', id);
      window.location.href = `/patient-edit.html?id=${id}`;
    }
    
    function deletePatient(id) {
      if (confirm('Are you sure you want to delete this patient?')) {
        alert('Delete patient with ID: ' + id);
        // In a real app, make API call to delete
      }
    }
  
  // Show raw MongoDB document in a Bootstrap modal (X-Ray)
  async function viewRaw(id) {
    try {
      const res = await fetch(`/api_mongo_patient_raw.php?id=${encodeURIComponent(id)}`, {
        credentials: 'include'
      });
      const text = await res.text();
      showRawModal(text);
    } catch (e) {
      alert('Failed to load raw document');
    }
  }
  
  function showRawModal(rawJson) {
    const modalId = 'rawModal';
    let modalEl = document.getElementById(modalId);
    if (!modalEl) {
      modalEl = document.createElement('div');
      modalEl.className = 'modal fade';
      modalEl.id = modalId;
      modalEl.tabIndex = -1;
      modalEl.innerHTML = `
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Raw MongoDB Document (Encrypted at Rest)</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="text-muted small">This is the raw document as stored in MongoDB. Encrypted fields appear as BinData subtype 6. The application decrypts fields before display based on role permissions.</p>
              <pre id="rawJsonPre" class="bg-dark text-warning p-3 rounded" style="white-space: pre-wrap; word-break: break-word; font-size: 0.85rem;"></pre>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modalEl);
    }
    const pre = modalEl.querySelector('#rawJsonPre');
    try {
      // If server returned canonical EJSON, pretty print it
      const maybeObj = JSON.parse(rawJson);
      pre.textContent = JSON.stringify(maybeObj, null, 2);
    } catch (_) {
      pre.textContent = rawJson;
    }
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }
  </script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>