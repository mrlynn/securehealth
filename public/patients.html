<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SecureHealth Patients</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Shared navbar styles -->
  <link href="/assets/css/navbar.css" rel="stylesheet">
  <!-- Role-aware navbar script -->
  <script src="/assets/js/navbar.js"></script>
  <!-- Patient verification script -->
  <script src="/assets/js/patient-verification.js"></script>
  <style>
    :root {
      --primary-color: #2c5aa0;
      --secondary-color: #1e3a5f;
      --accent-color: #4a90e2;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --light-bg: #f8f9fa;
      --dark-text: #2c3e50;
    }
    
    body { 
      background-color: #f8f9fa; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 80px;
    }
    
    /* Page-specific styles - navbar styles moved to shared CSS */
    
    /* Role badge styles moved to shared navbar.css */
    .encryption-badge {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: 4px;
      vertical-align: middle;
    }
    .encryption-deterministic { background-color: #0dcaf0; color: #055160; }
    .encryption-range { background-color: #20c997; color: #0f5132; }
    .encryption-standard { background-color: #6f42c1; color: white; }
    .sensitive-field { background-color: #fff3cd; border-left: 3px solid #ffc107; padding: 8px; margin: 2px 0; }
    .medical-field { background-color: #d1ecf1; border-left: 3px solid #0dcaf0; padding: 8px; margin: 2px 0; }
    .insurance-field { background-color: #d4edda; border-left: 3px solid #28a745; padding: 8px; margin: 2px 0; }
  </style>
</head>
<body>
  <!-- Role-aware navbar will be inserted here -->
  <div id="navbar-container"></div>

  <div class="container my-4">
    <div id="status" class="alert" style="display: none;"></div>
    
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Patient Records</h4>
        <div>
          <span id="roleInfo" class="text-muted small"></span>
          <button class="btn btn-outline-secondary btn-sm ms-2" id="toggleMaskingBtn" onclick="toggleDataMasking()" title="Toggle data masking">
            <i class="fas fa-eye-slash" id="maskingIcon"></i> Show Sensitive Data
          </button>
          <a href="/patient-add.html" class="btn btn-primary btn-sm ms-2" id="addPatientBtn" style="display: none;">Add New Patient</a>
        </div>
      </div>
      <div class="card-body">
        <div id="patientsList">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading patients data...</p>
          </div>
        </div>
      </div>
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const roleInfo = document.getElementById('roleInfo');
      const addPatientBtn = document.getElementById('addPatientBtn');
      const patientsList = document.getElementById('patientsList');
      const statusDiv = document.getElementById('status');
      
      let currentUser = null;
      let maskingEnabled = true; // Default to masked for security
      
      // Wait for navbar to initialize, then check authentication and load patients
      setTimeout(() => {
        checkAuthAndLoadPatients();
      }, 100);
      
      // Check authentication and load patients with session validation
      async function checkAuthAndLoadPatients() {
        // Load user data directly from localStorage first
        const storedUser = localStorage.getItem('securehealth_user');
        if (!storedUser) {
          console.log("No user in localStorage, redirecting to login");
          window.location.href = '/login.html';
          return;
        }
        
        try {
          currentUser = JSON.parse(storedUser);
        } catch (e) {
          console.error("Error parsing user data:", e);
          localStorage.removeItem('securehealth_user');
          window.location.href = '/login.html';
          return;
        }
        
        if (!currentUser) {
          console.log("No user found, redirecting to login");
          window.location.href = '/login.html';
          return;
        }
        
        console.log("User data from navbar:", currentUser);
        
        // Update role info
        updateRoleInfo();
        
        // Check for admin privileges
        checkAdminStatus();
        
        // Load patients data
        await loadPatients();
      }
      
      // Update role information display
      function updateRoleInfo() {
        const userRole = window.secureHealthNavbar.getCurrentUserRole();
        const isAdmin = window.secureHealthNavbar.hasRole('admin');
        const isDoctor = window.secureHealthNavbar.hasRole('doctor');
        const isNurse = window.secureHealthNavbar.hasRole('nurse');
        const isReceptionist = window.secureHealthNavbar.hasRole('receptionist');
        
        if (isAdmin) {
          roleInfo.innerHTML = '<strong>Administrator Access:</strong> Full system access including user management and system configuration.';
        } else if (isDoctor) {
          roleInfo.innerHTML = '<strong>Doctor Access:</strong> Full access to all patient data including SSN, medical history, and sensitive information.';
        } else if (isNurse) {
          roleInfo.innerHTML = '<strong>Nurse Access:</strong> Access to patient data for care coordination. Some sensitive information may be restricted.';
        } else if (isReceptionist) {
          roleInfo.innerHTML = '<strong>Receptionist Access:</strong> Basic patient information for scheduling and administrative tasks.';
        } else {
          roleInfo.innerHTML = '<strong>User Access:</strong> Limited access to patient information.';
        }
        
        // Show/hide add patient button based on role
        const canAddPatients = isAdmin || isDoctor;
        addPatientBtn.style.display = canAddPatients ? 'inline-block' : 'none';
      }
      
      // Check admin status (legacy function - now handled by navbar)
      function checkAdminStatus() {
        // Admin status is now handled by the navbar
        // This function is kept for compatibility
      }
      
      // Determine user role based on email/username patterns
      function determineUserRole(user) {
        const email = (user.email || '').toLowerCase();
        const username = (user.username || '').toLowerCase();
        
        // Check for admin first
        if (user.isAdmin || email.includes('admin') || username.includes('admin')) {
          return 'ADMIN';
        } else if (email.includes('doctor') || username.includes('doctor')) {
          return 'DOCTOR';
        } else if (email.includes('nurse') || username.includes('nurse')) {
          return 'NURSE';
        } else if (email.includes('receptionist') || username.includes('receptionist')) {
          return 'RECEPTIONIST';
        }
        
        // Default fallback
        return 'RECEPTIONIST';
      }
      
      // Set role-specific information and permissions
          function setRoleInfo(role) {
            switch(role) {
              case 'DOCTOR':
                roleInfo.textContent = 'Full access to all patient data including SSN, medical history, and sensitive information';
                addPatientBtn.style.display = 'inline-block';
                break;
              case 'NURSE':
                roleInfo.textContent = 'Access to medical information but not SSN or insurance details';
                addPatientBtn.style.display = 'none';
                break;
              case 'RECEPTIONIST':
                roleInfo.textContent = 'Access to basic patient info and insurance details only';
                addPatientBtn.style.display = 'none';
                break;
              case 'ADMIN':
                roleInfo.textContent = 'Administrative access to basic patient info and insurance. No access to medical data or SSN.';
                addPatientBtn.style.display = 'none';
                break;
            }
            
            // Check for admin privileges and show admin link
            checkAdminStatus();
          }
          
          // Check for admin privileges and show admin link
          function checkAdminStatus() {
            const adminLink = document.getElementById('adminLink');
            const scheduleLink = document.getElementById('scheduleLink');
            console.log('checkAdminStatus - adminLink:', adminLink);
            console.log('checkAdminStatus - currentUser:', currentUser);
            console.log('checkAdminStatus - currentUser.isAdmin:', currentUser ? currentUser.isAdmin : 'no currentUser');
            console.log('checkAdminStatus - currentUser.roles:', currentUser ? currentUser.roles : 'no currentUser');

            const roles = currentUser && Array.isArray(currentUser.roles) ? currentUser.roles : [];
            const hasRole = role => roles.includes(role);
            const isAdminUser = currentUser && (currentUser.isAdmin === true || hasRole('ROLE_ADMIN'));
            const isPureReceptionist = currentUser && hasRole('ROLE_RECEPTIONIST') && !hasRole('ROLE_NURSE') && !hasRole('ROLE_DOCTOR') && !hasRole('ROLE_ADMIN') && currentUser.isAdmin !== true;

            if (adminLink) {
              adminLink.style.display = isAdminUser ? 'inline-block' : 'none';
            }

            if (scheduleLink) {
              scheduleLink.style.display = isPureReceptionist ? 'inline-block' : 'none';
            }
          }
      
    // Load patients data with session validation
    async function loadPatients() {
      try {
        console.log("Attempting to fetch patients data");

        // Get user data for debugging
        const userData = localStorage.getItem('securehealth_user');
        console.log("User data from localStorage:", userData);

        // First validate session with health check
        console.log("Validating session...");
        const testResponse = await fetch('/api/health', {
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include'
        });

        console.log("Health check response:", testResponse.status);

        if (!testResponse.ok) {
          throw new Error(`Health check failed: ${testResponse.status}`);
        }

        // Now try patients API
        console.log("Fetching patients data...");
        const response = await fetch('/api/patients', {
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include'
        });

        console.log("Patients API response status:", response.status);

        if (response.status === 401) {
          // Session expired - clear localStorage and redirect
          console.log("Session expired, clearing localStorage and redirecting");
          localStorage.removeItem('securehealth_user');
          showStatus('Your session has expired. Please log in again.', 'info');
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 2000);
          return;
        }

        if (!response.ok) {
          const errorText = await response.text();
          console.error("API error response:", errorText);
          throw new Error(`Failed to load patients: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();

        console.log("API response data:", data);
        console.log("Data type:", typeof data);
        console.log("Is array:", Array.isArray(data));
        console.log("Data length:", data?.length);

        // Handle both array response and object with patients property
        let patientsArray = null;
        if (Array.isArray(data)) {
          patientsArray = data;
        } else if (data && data.patients && Array.isArray(data.patients)) {
          patientsArray = data.patients;
        } else if (data && data.error) {
          console.log("❌ Data has error property");
          throw new Error(data.message || 'API error');
        }

        if (patientsArray) {
          console.log("✅ Found patients array, rendering patients");
          window.currentPatientsData = patientsArray; // Store for re-rendering
          renderPatients(patientsArray);
          showStatus(`Loaded ${patientsArray.length} patients successfully`, 'success');
        } else {
          console.log("❌ No valid patients data found");
          console.log("Data structure:", Object.keys(data || {}));
          renderPatients([]);
          showStatus('No patients found or invalid data format', 'info');
        }
      } catch (error) {
        console.error("Failed to load data:", error);
        showStatus(`Error loading patients data: ${error.message}`, 'error');
        renderEmptyTable();
      }
    }
      
      // Render patients table with role-based access
      function renderPatients(patients) {
        if (patients.length === 0) {
          patientsList.innerHTML = '<div class="text-center py-4"><p class="text-muted">No patients found.</p></div>';
          return;
        }
        
        const userRole = determineUserRole(currentUser);
        
        // Generate table headers based on role
        const headers = generateTableHeaders(userRole);
        
        let html = `
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  ${headers}
                </tr>
              </thead>
              <tbody>
        `;
        
        patients.forEach(patient => {
          html += generatePatientRow(patient, userRole);
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
        
        // Add role-based access explanation
        html += generateRoleExplanation(userRole);
        
        patientsList.innerHTML = html;
      }
      
      // Generate table headers based on user role
      function generateTableHeaders(role) {
        let headers = '<th>Name <span class="encryption-badge encryption-deterministic">D</span></th>';
        headers += '<th>DOB <span class="encryption-badge encryption-range">R</span></th>';
        headers += '<th>Email <span class="encryption-badge encryption-deterministic">D</span></th>';
        headers += '<th>Phone <span class="encryption-badge encryption-deterministic">D</span></th>';
        
        switch(role) {
          case 'DOCTOR':
            headers += '<th>SSN <span class="encryption-badge encryption-standard">S</span></th>';
            headers += '<th>Medical Info <span class="encryption-badge encryption-standard">S</span></th>';
            headers += '<th>Insurance <span class="encryption-badge encryption-standard">S</span></th>';
            break;
          case 'NURSE':
            headers += '<th>Medical Info <span class="encryption-badge encryption-standard">S</span></th>';
            break;
          case 'RECEPTIONIST':
            headers += '<th>Insurance <span class="encryption-badge encryption-standard">S</span></th>';
            break;
          case 'ADMIN':
            headers += '<th>Insurance <span class="encryption-badge encryption-standard">S</span></th>';
            break;
        }
        
        headers += '<th>Actions</th>';
        return headers;
      }
      
      // Generate patient row based on user role
      function generatePatientRow(patient, role) {
        let row = `
          <tr>
            <td><strong>${patient.firstName || ''} ${patient.lastName || ''}</strong></td>
            <td>${formatDate(patient.birthDate)}</td>
            <td>${maskEmail(patient.email)}</td>
            <td>${maskPhone(patient.phoneNumber || patient.phone)}</td>
        `;
        
        switch(role) {
          case 'DOCTOR':
            // Doctors see everything but with masking for security
            row += `<td class="sensitive-field">${maskSSN(patient.ssn)}</td>`;
            row += `<td class="medical-field">
              <div><strong>Diagnosis:</strong> ${formatArray(patient.diagnosis)}</div>
              <div><strong>Medications:</strong> ${formatArray(patient.medications)}</div>
            </td>`;
            row += `<td class="insurance-field">
              <div><strong>Provider:</strong> ${patient.insuranceDetails?.provider || 'Not provided'}</div>
              <div><strong>Policy:</strong> ${maskPolicyNumber(patient.insuranceDetails?.policyNumber)}</div>
            </td>`;
            break;
          case 'NURSE':
            // Nurses see medical info but not SSN
            row += `<td class="medical-field">
              <div><strong>Diagnosis:</strong> ${formatArray(patient.diagnosis)}</div>
              <div><strong>Medications:</strong> ${formatArray(patient.medications)}</div>
            </td>`;
            break;
          case 'RECEPTIONIST':
            // Receptionists see insurance but no medical data
            row += `<td class="insurance-field">
              <div><strong>Provider:</strong> ${patient.insuranceDetails?.provider || 'Not provided'}</div>
              <div><strong>Policy:</strong> ${maskPolicyNumber(patient.insuranceDetails?.policyNumber)}</div>
            </td>`;
            break;
          case 'ADMIN':
            // Admins see insurance but no medical data or SSN
            row += `<td class="insurance-field">
              <div><strong>Provider:</strong> ${patient.insuranceDetails?.provider || 'Not provided'}</div>
              <div><strong>Policy:</strong> ${maskPolicyNumber(patient.insuranceDetails?.policyNumber)}</div>
            </td>`;
            break;
        }
        
        // Actions based on role
        row += `<td>${generateActionButtons(patient, role)}</td>`;
        row += '</tr>';
        
        return row;
      }
      
      // Generate action buttons based on role
      function generateActionButtons(patient, role) {
        let buttons = `<button class="btn btn-sm btn-outline-primary" onclick="viewPatient('${patient.id}')">View</button>`;
        
        // Only doctors can edit/delete
        if (role === 'DOCTOR') {
          buttons += ` <button class="btn btn-sm btn-outline-secondary" onclick="editPatient('${patient.id}')">Edit</button>`;
          buttons += ` <button class="btn btn-sm btn-outline-danger" onclick="deletePatient('${patient.id}')">Delete</button>`;
        }
        // Admins cannot edit/delete patient records
        if (role === 'ADMIN') {
          buttons += ` <span class="text-muted small">View Only</span>`;
        }
        // X-Ray is visible to all roles for educational purposes
        buttons += ` <button class="btn btn-sm btn-warning" onclick="viewRaw('${patient.id}')">X-Ray</button>`;
        
        return buttons;
      }
      
      // Toggle data masking - moved to global scope
      window.toggleDataMasking = function() {
        maskingEnabled = !maskingEnabled;
        const icon = document.getElementById('maskingIcon');
        const button = document.getElementById('toggleMaskingBtn');
        
        if (maskingEnabled) {
          icon.className = 'fas fa-eye-slash';
          button.innerHTML = '<i class="fas fa-eye-slash" id="maskingIcon"></i> Show Sensitive Data';
          button.className = 'btn btn-outline-secondary btn-sm ms-2';
        } else {
          icon.className = 'fas fa-eye';
          button.innerHTML = '<i class="fas fa-eye" id="maskingIcon"></i> Hide Sensitive Data';
          button.className = 'btn btn-outline-warning btn-sm ms-2';
        }
        
        // Re-render the patients table with new masking setting
        if (window.currentPatientsData) {
          renderPatients(window.currentPatientsData);
        }
      }

      // Mask sensitive data for display
      function maskEmail(email) {
        if (!email) return '';
        if (!maskingEnabled) return email;
        
        const [localPart, domain] = email.split('@');
        if (!localPart || !domain) return email;
        
        if (localPart.length <= 2) {
          return `${localPart[0]}*@${domain}`;
        }
        return `${localPart[0]}${'*'.repeat(localPart.length - 2)}${localPart[localPart.length - 1]}@${domain}`;
      }
      
      function maskPhone(phone) {
        if (!phone) return '';
        if (!maskingEnabled) return phone;
        
        // Remove all non-digits
        const digits = phone.replace(/\D/g, '');
        if (digits.length < 4) return phone;
        
        // Show last 4 digits, mask the rest
        const masked = '*'.repeat(digits.length - 4) + digits.slice(-4);
        
        // Format back to phone number format if it was formatted
        if (phone.includes('-')) {
          return masked.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
        } else if (phone.includes('(')) {
          return masked.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
        }
        return masked;
      }
      
      function maskSSN(ssn) {
        if (!ssn) return 'Not provided';
        if (!maskingEnabled) return ssn;
        
        // Remove all non-digits
        const digits = ssn.replace(/\D/g, '');
        if (digits.length !== 9) return ssn;
        
        // Show last 4 digits, mask the rest
        return `***-**-${digits.slice(-4)}`;
      }
      
      function maskPolicyNumber(policyNumber) {
        if (!policyNumber) return 'Not provided';
        if (!maskingEnabled) return policyNumber;
        if (policyNumber.length <= 4) return policyNumber;
        
        // Show last 4 characters, mask the rest
        return '*'.repeat(policyNumber.length - 4) + policyNumber.slice(-4);
      }

      // Format array data for display
      function formatArray(arr) {
        if (!arr || !Array.isArray(arr) || arr.length === 0) {
          return 'None';
        }
        return arr.slice(0, 2).join(', ') + (arr.length > 2 ? ` (+${arr.length - 2} more)` : '');
      }
      
      // Generate role-based access explanation
      function generateRoleExplanation(role) {
        let explanation = `
          <div class="mt-4">
            <div class="card border-0 bg-light">
              <div class="card-body">
                <h6 class="card-title">Role-Based Access Control (RBAC) & Data Masking</h6>
                <p class="card-text small mb-2">This system demonstrates HIPAA-compliant role-based access control using MongoDB Queryable Encryption with data masking for enhanced security:</p>
        `;
        
        switch(role) {
          case 'DOCTOR':
            explanation += `
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-success">✓ What you can see:</h6>
                    <ul class="small">
                      <li><strong>All patient data</strong> including SSN, medical history, medications</li>
                      <li><strong>Insurance information</strong> for billing purposes</li>
                      <li><strong>Full edit/delete permissions</strong> for patient records</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-info">Security features:</h6>
                    <ul class="small">
                      <li><span class="encryption-badge encryption-deterministic">D</span> Deterministic - Searchable fields</li>
                      <li><span class="encryption-badge encryption-range">R</span> Range - Date queries</li>
                      <li><span class="encryption-badge encryption-standard">S</span> Standard - Maximum security</li>
                      <li><strong>Data Masking:</strong> Sensitive fields partially hidden</li>
                    </ul>
                  </div>
                </div>
            `;
            break;
          case 'NURSE':
            explanation += `
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-success">✓ What you can see:</h6>
                    <ul class="small">
                      <li><strong>Medical information</strong> (diagnosis, medications)</li>
                      <li><strong>Basic patient data</strong> (name, DOB, contact info)</li>
                      <li><strong>View-only access</strong> to patient records</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-danger">✗ What you cannot see:</h6>
                    <ul class="small">
                      <li><strong>SSN</strong> - Not needed for medical care</li>
                      <li><strong>Insurance details</strong> - Handled by reception</li>
                      <li><strong>Edit/Delete permissions</strong> - Doctor-only actions</li>
                    </ul>
                  </div>
                </div>
            `;
            break;
          case 'RECEPTIONIST':
            explanation += `
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-success">✓ What you can see:</h6>
                    <ul class="small">
                      <li><strong>Insurance information</strong> for billing and scheduling</li>
                      <li><strong>Basic patient data</strong> (name, DOB, contact info)</li>
                      <li><strong>View-only access</strong> to patient records</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-danger">✗ What you cannot see:</h6>
                    <ul class="small">
                      <li><strong>Medical information</strong> - Not needed for scheduling</li>
                      <li><strong>SSN</strong> - Not needed for front desk operations</li>
                      <li><strong>Edit/Delete permissions</strong> - Doctor-only actions</li>
                    </ul>
                  </div>
                </div>
            `;
            break;
          case 'ADMIN':
            explanation += `
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-success">✓ What you can see:</h6>
                    <ul class="small">
                      <li><strong>Basic patient data</strong> (name, DOB, contact info)</li>
                      <li><strong>Insurance information</strong> for administrative purposes</li>
                      <li><strong>Audit logs and system monitoring</strong></li>
                      <li><strong>User management capabilities</strong></li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-danger">✗ What you cannot see:</h6>
                    <ul class="small">
                      <li><strong>Medical information</strong> - Not needed for administration</li>
                      <li><strong>SSN</strong> - Not needed for administrative tasks</li>
                      <li><strong>Edit/Delete patient records</strong> - Medical staff only</li>
                    </ul>
                  </div>
                </div>
            `;
            break;
        }
        
        explanation += `
                <div class="mt-3">
                  <p class="small text-muted mb-0">
                    <strong>Security Note:</strong> This demonstrates the "minimum necessary" rule of HIPAA - users only see the data they need for their job function. 
                    All sensitive data is encrypted using MongoDB Queryable Encryption, and sensitive fields are masked in the listing view for additional protection. 
                    Full details are available in the patient detail view when needed.
                  </p>
                </div>
              </div>
            </div>
          </div>
        `;
        
        return explanation;
      }
      
      // Render empty table
      function renderEmptyTable() {
        patientsList.innerHTML = `
          <div class="text-center py-4">
            <div class="alert alert-warning">
              <h5>Unable to load patients data</h5>
              <p class="mb-0">Please check your connection and try again.</p>
            </div>
          </div>
        `;
      }
      
      // Format date
      function formatDate(dateString) {
        if (!dateString) return '';
        
        try {
          // Handle YYYY-MM-DD format specifically to avoid timezone issues
          if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
            const [year, month, day] = dateString.split('-');
            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            return date.toLocaleDateString();
          }
          
          const date = new Date(dateString);
          return date.toLocaleDateString();
        } catch (e) {
          return dateString;
        }
      }
      
      // Logout function (legacy - now handled by navbar)
      async function handleLogout() {
        // Logout is now handled by the navbar
        // This function is kept for compatibility
      }
      
      // Display status message
      function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
        statusDiv.style.display = 'block';
        
        // Auto-hide success/info messages after 5 seconds
        if (type === 'success' || type === 'info') {
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 5000);
        }
      }
    });
    
    // Patient action functions (declared in global scope for onclick handlers)
    async function viewPatient(id) {
      console.log('Attempting to view patient detail page for ID:', id);
      
      // Check if verification is required
      const verificationRequired = await window.patientVerification.checkVerificationRequired(id);
      if (verificationRequired && !window.patientVerification.isPatientVerified(id)) {
        // Show verification modal
        window.patientVerification.showVerificationModal(id, (success, patientData) => {
          if (success) {
            console.log('Patient verified, navigating to detail page');
            window.location.href = `/patient-detail.html?id=${id}`;
          } else {
            console.log('Patient verification failed');
          }
        });
      } else {
        // No verification required or already verified
        window.location.href = `/patient-detail.html?id=${id}`;
      }
    }
    
    async function editPatient(id) {
      console.log('Attempting to edit patient for ID:', id);
      
      // Check if verification is required
      const verificationRequired = await window.patientVerification.checkVerificationRequired(id);
      if (verificationRequired && !window.patientVerification.isPatientVerified(id)) {
        // Show verification modal
        window.patientVerification.showVerificationModal(id, (success, patientData) => {
          if (success) {
            console.log('Patient verified, navigating to edit page');
            window.location.href = `/patient-edit.html?id=${id}`;
          } else {
            console.log('Patient verification failed');
          }
        });
      } else {
        // No verification required or already verified
        window.location.href = `/patient-edit.html?id=${id}`;
      }
    }
    
    function deletePatient(id) {
      if (confirm('Are you sure you want to delete this patient?')) {
        alert('Delete patient with ID: ' + id);
        // In a real app, make API call to delete
      }
    }
  
  // Show raw MongoDB document in a Bootstrap modal (X-Ray)
  async function viewRaw(id) {
    try {
      const res = await fetch(`/api_mongo_patient_raw.php?id=${encodeURIComponent(id)}`, {
        credentials: 'include'
      });
      const text = await res.text();
      showRawModal(text);
    } catch (e) {
      alert('Failed to load raw document');
    }
  }
  
  function showRawModal(rawJson) {
    const modalId = 'rawModal';
    let modalEl = document.getElementById(modalId);
    if (!modalEl) {
      modalEl = document.createElement('div');
      modalEl.className = 'modal fade';
      modalEl.id = modalId;
      modalEl.tabIndex = -1;
      modalEl.innerHTML = `
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Raw MongoDB Document (Encrypted at Rest)</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="text-muted small">This is the raw document as stored in MongoDB. Encrypted fields appear as BinData subtype 6. The application decrypts fields before display based on role permissions.</p>
              <pre id="rawJsonPre" class="bg-dark text-warning p-3 rounded" style="white-space: pre-wrap; word-break: break-word; font-size: 0.85rem;"></pre>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(modalEl);
    }
    const pre = modalEl.querySelector('#rawJsonPre');
    try {
      // If server returned canonical EJSON, pretty print it
      const maybeObj = JSON.parse(rawJson);
      pre.textContent = JSON.stringify(maybeObj, null, 2);
    } catch (_) {
      pre.textContent = rawJson;
    }
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }
  </script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>