<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Control Testing - SecureHealth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background: #f5f5f5;
        }
        .test-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result-success { color: #28a745; }
        .result-warning { color: #ffc107; }
        .result-error { color: #dc3545; }
        .log-entry {
            font-family: monospace;
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #ccc;
            padding-left: 10px;
        }
        .log-success { border-left-color: #28a745; }
        .log-warning { border-left-color: #ffc107; }
        .log-error { border-left-color: #dc3545; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">
            <i class="fas fa-shield-alt"></i> Access Control Testing
        </h1>

        <div class="alert alert-info">
            <strong><i class="fas fa-info-circle"></i> Purpose:</strong>
            This page helps diagnose authentication and authorization issues. Open browser console for detailed logs.
        </div>

        <!-- Current User Panel -->
        <div class="test-panel">
            <h3><i class="fas fa-user"></i> Current User Status</h3>
            <div id="currentUserStatus">
                <p class="text-muted">Checking...</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="test-panel">
            <h3><i class="fas fa-play-circle"></i> Quick Actions</h3>
            <div class="btn-group mb-3" role="group">
                <button class="btn btn-primary" onclick="runFullAudit()">
                    <i class="fas fa-check-circle"></i> Run Full Audit
                </button>
                <button class="btn btn-secondary" onclick="checkSession()">
                    <i class="fas fa-user-check"></i> Check Session
                </button>
                <button class="btn btn-info" onclick="testAPIs()">
                    <i class="fas fa-code"></i> Test APIs
                </button>
                <button class="btn btn-warning" onclick="clearAll()">
                    <i class="fas fa-trash"></i> Clear All Data
                </button>
            </div>
        </div>

        <!-- Test Results -->
        <div class="test-panel">
            <h3><i class="fas fa-clipboard-check"></i> Test Results</h3>
            <div id="testResults">
                <p class="text-muted">Run a test to see results...</p>
            </div>
        </div>

        <!-- API Test Panel -->
        <div class="test-panel">
            <h3><i class="fas fa-network-wired"></i> API Access Test</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Test Endpoint:</h5>
                    <select id="endpointSelect" class="form-select mb-2">
                        <option value="/api/user">GET /api/user</option>
                        <option value="/api/patients">GET /api/patients</option>
                        <option value="/api/appointments">GET /api/appointments</option>
                        <option value="/api/medical-knowledge/stats">GET /api/medical-knowledge/stats</option>
                        <option value="/api/audit-logs">GET /api/audit-logs</option>
                        <option value="/api/conversations/inbox">GET /api/conversations/inbox</option>
                        <option value="/api/admin/stats">GET /api/admin/stats</option>
                    </select>
                    <button class="btn btn-primary" onclick="testEndpoint()">
                        <i class="fas fa-paper-plane"></i> Test Endpoint
                    </button>
                </div>
                <div class="col-md-6">
                    <h5>Response:</h5>
                    <pre id="endpointResponse" style="max-height: 300px; overflow-y: auto;">No response yet</pre>
                </div>
            </div>
        </div>

        <!-- Page Access Test -->
        <div class="test-panel">
            <h3><i class="fas fa-file-alt"></i> Page Access Test</h3>
            <div class="row">
                <div class="col-md-12">
                    <div class="table-responsive">
                        <table class="table table-sm" id="pageAccessTable">
                            <thead>
                                <tr>
                                    <th>Page</th>
                                    <th>Required Roles</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="4" class="text-center text-muted">Click "Test All Pages" to check access</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary" onclick="testAllPages()">
                        <i class="fas fa-check-double"></i> Test All Pages
                    </button>
                </div>
            </div>
        </div>

        <!-- Console Log -->
        <div class="test-panel">
            <h3><i class="fas fa-terminal"></i> Console Log</h3>
            <div id="consoleLog" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <div class="text-muted">Console messages will appear here...</div>
            </div>
            <button class="btn btn-sm btn-secondary mt-2" onclick="clearConsoleLog()">
                <i class="fas fa-eraser"></i> Clear Log
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/auth-guard.js"></script>
    <script src="/assets/js/access-audit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Hijack console.log for display
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function logToPage(message, type = 'log') {
            const logDiv = document.getElementById('consoleLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type === 'error' ? 'error' : type === 'warn' ? 'warning' : 'success'}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToPage(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logToPage(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logToPage(args.join(' '), 'error');
        };

        // On page load
        document.addEventListener('DOMContentLoaded', async function() {
            await checkCurrentUser();
        });

        async function checkCurrentUser() {
            const statusDiv = document.getElementById('currentUserStatus');
            
            try {
                const response = await fetch('/api/user', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const user = data.user;
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="fas fa-check-circle"></i> Authenticated</h5>
                                <p><strong>Username:</strong> ${user.username}</p>
                                <p><strong>Roles:</strong> ${user.roles.join(', ')}</p>
                                <p><strong>Permissions:</strong></p>
                                <ul>
                                    ${user.isAdmin ? '<li>✓ Admin</li>' : ''}
                                    ${user.isDoctor ? '<li>✓ Doctor</li>' : ''}
                                    ${user.isNurse ? '<li>✓ Nurse</li>' : ''}
                                    ${user.isReceptionist ? '<li>✓ Receptionist</li>' : ''}
                                    ${user.isPatient ? '<li>✓ Patient</li>' : ''}
                                </ul>
                            </div>
                        `;
                    }
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-times-circle"></i> Not Authenticated</h5>
                            <p>Status: ${response.status} ${response.statusText}</p>
                            <a href="/login.html" class="btn btn-primary">Login</a>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function runFullAudit() {
            const results = await runAccessAudit();
            displayTestResults(results);
        }

        async function checkSession() {
            await checkCurrentUser();
        }

        async function testAPIs() {
            console.log('🌐 Testing API endpoints...');
            const endpoints = [
                '/api/user',
                '/api/patients',
                '/api/appointments',
                '/api/medical-knowledge/stats',
            ];

            for (const endpoint of endpoints) {
                await testSingleEndpoint(endpoint);
            }
        }

        async function testEndpoint() {
            const endpoint = document.getElementById('endpointSelect').value;
            await testSingleEndpoint(endpoint);
        }

        async function testSingleEndpoint(endpoint) {
            const responseDiv = document.getElementById('endpointResponse');
            
            try {
                const response = await fetch(endpoint, {
                    credentials: 'include'
                });

                const data = await response.json();
                
                responseDiv.textContent = `Status: ${response.status} ${response.statusText}\n\n${JSON.stringify(data, null, 2)}`;
                
                if (response.ok) {
                    console.log(`✅ ${endpoint} - OK`);
                } else {
                    console.error(`❌ ${endpoint} - ${response.status}`);
                }
            } catch (error) {
                responseDiv.textContent = `Error: ${error.message}`;
                console.error(`❌ ${endpoint} - ${error.message}`);
            }
        }

        async function testAllPages() {
            const pages = [
                { name: 'calendar', roles: ['All authenticated users'] },
                { name: 'patients', roles: ['ROLE_DOCTOR', 'ROLE_NURSE', 'ROLE_RECEPTIONIST', 'ROLE_ADMIN'] },
                { name: 'patient-add', roles: ['ROLE_DOCTOR', 'ROLE_NURSE', 'ROLE_RECEPTIONIST'] },
                { name: 'scheduling', roles: ['All staff'] },
                { name: 'medical-knowledge-search', roles: ['ROLE_DOCTOR', 'ROLE_NURSE', 'ROLE_ADMIN'] },
                { name: 'admin', roles: ['ROLE_ADMIN', 'ROLE_DOCTOR'] },
                { name: 'admin-demo-data', roles: ['ROLE_ADMIN'] },
            ];

            const tbody = document.querySelector('#pageAccessTable tbody');
            tbody.innerHTML = '';

            for (const page of pages) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${page.name}.html</td>
                    <td><small>${page.roles.join(', ')}</small></td>
                    <td id="status-${page.name}"><span class="text-muted">Testing...</span></td>
                    <td><button class="btn btn-sm btn-outline-primary" onclick="window.open('/${page.name}.html', '_blank')">Open</button></td>
                `;

                // Test access
                try {
                    const response = await fetch(`/api/verify-access/${page.name}`, {
                        credentials: 'include'
                    });

                    const data = await response.json();
                    const statusCell = document.getElementById(`status-${page.name}`);

                    if (data.success && data.hasAccess) {
                        statusCell.innerHTML = '<span class="result-success"><i class="fas fa-check-circle"></i> Access granted</span>';
                    } else if (response.status === 403) {
                        statusCell.innerHTML = '<span class="result-warning"><i class="fas fa-ban"></i> Access denied</span>';
                    } else {
                        statusCell.innerHTML = '<span class="result-error"><i class="fas fa-times-circle"></i> Error</span>';
                    }
                } catch (error) {
                    const statusCell = document.getElementById(`status-${page.name}`);
                    statusCell.innerHTML = '<span class="result-error"><i class="fas fa-exclamation-triangle"></i> Error</span>';
                }
            }
        }

        function displayTestResults(results) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <h5>Audit Complete</h5>
                    <p><strong>Total Tests:</strong> ${results.total}</p>
                    <p><strong class="result-success">Success:</strong> ${results.success}</p>
                    <p><strong class="result-warning">Warnings:</strong> ${results.warnings}</p>
                    <p><strong class="result-error">Errors:</strong> ${results.errors}</p>
                </div>
                <p class="text-muted">See browser console for detailed results.</p>
            `;
        }

        function clearAll() {
            if (confirm('Clear all authentication data (localStorage and cookies)? You will need to login again.')) {
                localStorage.clear();
                console.log('✅ localStorage cleared');
                alert('Authentication data cleared. Please log in again.');
                window.location.href = '/login.html';
            }
        }

        function clearConsoleLog() {
            document.getElementById('consoleLog').innerHTML = '<div class="text-muted">Console cleared...</div>';
        }
    </script>
</body>
</html>

