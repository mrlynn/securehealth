<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Details - SecureHealth</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Shared navbar styles -->
  <link href="/assets/css/navbar.css" rel="stylesheet">
  <!-- Role-aware navbar script -->
  <script src="/assets/js/navbar.js"></script>
  <!-- Patient verification script -->
  <script src="/assets/js/patient-verification.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <style>
    /* Page-specific styles - navbar styles moved to shared CSS */
    
    body { 
      background-color: #f8f9fa; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #e9ecef;
      color: #495057;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.125rem;
    }
    .info-label { color: #6c757d; font-weight: 500; }
    .loading { text-align: center; padding: 40px; color: #6c757d; }
    .encryption-badge { display: inline-block; font-size: 12px; padding: 2px 8px; border-radius: 12px; margin-left: 5px; vertical-align: middle; }
    .encryption-deterministic {
      background-color: #0dcaf0;
      color: #055160;
    }
    .encryption-range {
      background-color: #20c997;
      color: #0f5132;
    }
    .encryption-standard {
      background-color: #6f42c1;
      color: white;
    }
    .status { display: none; }
    .error { background-color: #f8d7da; color: #842029; }
    /* Role badge styles moved to shared navbar.css */
    .sensitive-field { background-color: #fff3cd; border-left: 3px solid #ffc107; padding: 8px; margin: 2px 0; }
    .medical-field { background-color: #d1ecf1; border-left: 3px solid #0dcaf0; padding: 8px; margin: 2px 0; }
    .insurance-field { background-color: #d4edda; border-left: 3px solid #28a745; padding: 8px; margin: 2px 0; }
    .restricted-field { background-color: #f8d7da; border-left: 3px solid #dc3545; padding: 8px; margin: 2px 0; color: #842029; }
    
    /* Note card styles */
    .border-left-primary { border-left: 4px solid #007bff !important; }
    .note-content { white-space: pre-wrap; line-height: 1.6; }
    .card.border-left-primary { transition: box-shadow 0.3s ease; }
    .card.border-left-primary:hover { box-shadow: 0 4px 8px rgba(0,123,255,0.15); }
  </style>
</head>
<body>
  <!-- Role-aware navbar will be inserted here -->
  <div id="navbar-container"></div>

  <div class="container my-4">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/patients.html">Patients</a></li>
        <li class="breadcrumb-item active" aria-current="page">Patient Details</li>
      </ol>
    </nav>
    <div id="status" class="status"></div>
    <div id="patientDetail" class="loading">Loading patient details...</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const patientDetail = document.getElementById('patientDetail');
      const statusDiv = document.getElementById('status');
      
      let currentUser = null;
      
      // Wait for navbar to initialize, then check authentication
      setTimeout(() => {
        checkAuth();
      }, 100);
      
      // Get patient ID from URL
      const params = new URLSearchParams(window.location.search);
      const patientId = params.get('id');
      
      if (!patientId) {
        showStatus('No patient ID provided', 'error');
        patientDetail.innerHTML = '<p>Error: No patient ID provided</p>';
        return;
      }
      
      // Load patient data
      loadPatientDetail(patientId);
      
      // Check if user is authenticated
      function checkAuth() {
        // Get user from navbar
        currentUser = window.secureHealthNavbar.getCurrentUser();
        
        if (!currentUser) {
          console.log("No user found, redirecting to login");
          window.location.href = '/login.html';
          return;
        }
        
        console.log("User data from navbar:", currentUser);
        
        // Check if patient verification is available
        if (typeof window.patientVerification === 'undefined') {
          console.error("Patient verification system not loaded!");
          showStatus('Patient verification system not available. Please refresh the page.', 'error');
        } else {
          console.log("Patient verification system loaded successfully");
          // Initialize the verification system
          window.patientVerification.init();
        }
      }
      
      // Determine user role based on email/username patterns (legacy function)
      function determineUserRole(user) {
        return window.secureHealthNavbar.getCurrentUserRole();
      }
      
      // Check for admin privileges and show admin link (legacy function)
      function checkAdminStatus() {
        // Admin status is now handled by the navbar
      }
      
      // Load patient detail
      async function loadPatientDetail(id) {
        console.log("Loading patient detail for ID:", id);
        
        try {
          // Use the verification system to handle patient data loading
          const apiUrl = `${window.location.origin}/api/patients/${id}`;
          console.log("Fetching from API URL:", apiUrl);
          
          const response = await window.patientVerification.fetchWithVerification(apiUrl, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include'
          }, 'view');
          
          if (!response.ok) {
            if (response.status === 404) {
              throw new Error("Patient not found");
            } else {
              throw new Error(`Failed to load patient data: ${response.status} ${response.statusText}`);
            }
          }
          
          const patient = await response.json();
          console.log("API response:", patient);
          console.log("Response status:", response.status);
          console.log("Response headers:", response.headers);
          
          // Process patient data
          const userRole = determineUserRole(currentUser);
          processPatientData(patient, id, userRole);
        } catch (error) {
          console.error("Error loading patient:", error);
          showStatus('Error loading patient data', 'error');
          patientDetail.innerHTML = `<p>Error: ${error.message || 'Failed to load patient'}</p>`;
        }
      }
      
      // Process patient data
      function processPatientData(patient, id, userRole) {
        // Handle potential MongoDB format differences
        if (patient._id && !patient.id) {
          patient.id = patient._id;
        }
        
        // Map API fields to UI fields
        patient.id = patient.id || id;
        patient.allergies = patient.allergies || [];
        patient.conditions = patient.diagnosis || [];
        patient.address = patient.address || '';
        patient.phone = patient.phoneNumber || patient.phone || '';
        
        // Handle insurance details which might be either object or array
        if (patient.insuranceDetails) {
          if (typeof patient.insuranceDetails === 'object' && patient.insuranceDetails !== null) {
            patient.insuranceProvider = patient.insuranceDetails.provider || '';
            patient.insuranceNumber = patient.insuranceDetails.policyNumber || '';
          } else if (Array.isArray(patient.insuranceDetails) && patient.insuranceDetails.length > 0) {
            // If it's an array, try to get the first item's properties
            patient.insuranceProvider = patient.insuranceDetails[0].provider || '';
            patient.insuranceNumber = patient.insuranceDetails[0].policyNumber || '';
          }
        } else {
          // If no insurance details in the object, use the direct properties if available
          patient.insuranceProvider = patient.insuranceProvider || '';
          patient.insuranceNumber = patient.insuranceNumber || '';
        }
        
        console.log("Patient data mapped for UI:", patient);
        console.log("Patient birthDate:", patient.birthDate, typeof patient.birthDate);
        
        // Render patient detail
        renderPatientDetail(patient, userRole);
        
        // Load patient's appointments
        loadPatientAppointments(patient.id);
        
        // Load patient's notes if user is a doctor
        if (userRole === 'DOCTOR') {
          loadPatientNotes(patient.id);
        }
      }
      
      // Render patient detail with role-based access control
      function renderPatientDetail(patient, userRole) {
        const initials = `${(patient.firstName || '?')[0] || '?'}` + `${(patient.lastName || '?')[0] || '?'}`;
        const statusBadge = `<span class="badge rounded-pill ${patient.status === 'active' ? 'bg-success' : (patient.status === 'inactive' ? 'bg-secondary' : 'bg-warning text-dark')}">${patient.status || 'active'}</span>`;
        
        // Role-based data access
        const allergies = patient.allergies && patient.allergies.length ? patient.allergies.map(a => `<span class="badge text-bg-light me-1 mb-1">${a}</span>`).join('') : '<span class="text-muted">None reported</span>';
        const conditions = (patient.diagnosis && patient.diagnosis.length ? patient.diagnosis : (patient.conditions || []));
        const conditionsHtml = conditions && conditions.length ? conditions.map(c => `<span class="badge text-bg-light me-1 mb-1">${c}</span>`).join('') : '<span class="text-muted">None reported</span>';
        const medsHtml = patient.medications && patient.medications.length ? patient.medications.map(m => `<span class="badge text-bg-light me-1 mb-1">${m}</span>`).join('') : '<span class="text-muted">None</span>';
        
        // Determine what data to show based on role
        const canViewMedical = userRole === 'DOCTOR' || userRole === 'NURSE';
        const canViewSSN = userRole === 'DOCTOR';
        const canViewInsurance = userRole === 'DOCTOR' || userRole === 'NURSE' || userRole === 'RECEPTIONIST' || userRole === 'ADMIN';
        const canEdit = userRole === 'DOCTOR';

        const html = `
          <div class="row g-4">
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                    <div class="d-flex align-items-center gap-3">
                      <div class="avatar">${initials.toUpperCase()}</div>
                      <div>
                        <h3 class="mb-0">${patient.firstName || ''} ${patient.lastName || ''} ${statusBadge}</h3>
                        <small class="text-muted">ID: ${patient.id}</small>
                      </div>
                    </div>
                    <div class="d-flex gap-2">
                      ${canEdit ? `
                        <a href="/patient-edit.html?id=${patient.id}" class="btn btn-primary">Edit Patient</a>
                        <button onclick="deletePatient('${patient.id}')" class="btn btn-outline-danger">Delete</button>
                      ` : `
                        <span class="text-muted small">View Only - ${userRole} Access</span>
                      `}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-12 col-lg-6">
              <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                  <strong>Contact & Demographics</strong>
                </div>
                <div class="card-body">
                  <div class="row gy-3">
                    <div class="col-6">
                      <div class="info-label">Date of Birth <span class="encryption-badge encryption-range">R</span></div>
                      <div>${formatDate(patient.birthDate)}</div>
                    </div>
                    <div class="col-6">
                      <div class="info-label">Email <span class="encryption-badge encryption-deterministic">D</span></div>
                      <div>${patient.email || ''}</div>
                    </div>
                    <div class="col-6">
                      <div class="info-label">Phone</div>
                      <div>${patient.phone || ''}</div>
                    </div>
                    <div class="col-12">
                      <div class="info-label">Address <span class="encryption-badge encryption-standard">S</span></div>
                      <div>${patient.address || ''}</div>
                    </div>
                    ${canViewSSN ? `
                    <div class="col-12">
                      <div class="info-label sensitive-field">Social Security Number <span class="encryption-badge encryption-standard">S</span></div>
                      <div>${patient.ssn || 'Not provided'}</div>
                    </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>

            ${canViewInsurance ? `
            <div class="col-12 col-lg-6">
              <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                  <strong>Insurance <span class="encryption-badge encryption-standard">S</span></strong>
                </div>
                <div class="card-body">
                  <div class="row gy-3">
                    <div class="col-6">
                      <div class="info-label">Provider</div>
                      <div class="insurance-field">${patient.insuranceProvider || patient.insuranceDetails?.provider || 'Not provided'}</div>
                    </div>
                    <div class="col-6">
                      <div class="info-label">Policy Number <span class="encryption-badge encryption-standard">S</span></div>
                      <div class="insurance-field">${patient.insuranceNumber || patient.insuranceDetails?.policyNumber || 'Not provided'}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            ` : ''}

            ${canViewMedical ? `
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header bg-white">
                  <strong>Medical Overview <span class="encryption-badge encryption-standard">S</span></strong>
                </div>
                <div class="card-body">
                  <div class="row gy-4">
                    <div class="col-12 col-lg-4">
                      <div class="info-label mb-2">Allergies</div>
                      <div class="medical-field">${allergies}</div>
                    </div>
                    <div class="col-12 col-lg-4">
                      <div class="info-label mb-2">Conditions / Diagnosis <span class="encryption-badge encryption-standard">S</span></div>
                      <div class="medical-field">${conditionsHtml}</div>
                    </div>
                    <div class="col-12 col-lg-4">
                      <div class="info-label mb-2">Medications <span class="encryption-badge encryption-standard">S</span></div>
                      <div class="medical-field">${medsHtml}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            ${userRole === 'DOCTOR' ? `
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header bg-white d-flex align-items-center justify-content-between">
                  <strong>Medical Notes <span class="encryption-badge encryption-standard">S</span></strong>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-primary" onclick="openAddNoteModal('${patient.id}')">
                      <i class="fas fa-plus me-1"></i>Add Note
                    </button>
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fas fa-robot me-1"></i>AI Assistant
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#" onclick="openAISoapModal('${patient.id}')">
                        <i class="fas fa-clipboard-list me-2"></i>Generate SOAP Note
                      </a></li>
                      <li><a class="dropdown-item" href="#" onclick="openAISummaryModal('${patient.id}')">
                        <i class="fas fa-file-alt me-2"></i>Generate Visit Summary
                      </a></li>
                      <li><a class="dropdown-item" href="#" onclick="openAIEnhancementModal('${patient.id}')">
                        <i class="fas fa-magic me-2"></i>Enhance Notes
                      </a></li>
                      <li><a class="dropdown-item" href="#" onclick="openAICodesModal('${patient.id}')">
                        <i class="fas fa-code me-2"></i>Suggest ICD Codes
                      </a></li>
                    </ul>
                  </div>
                </div>
                <div class="card-body">
                  <div id="notesLoading" class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading notes...</p>
                  </div>
                  <div id="notesList" class="d-none"></div>
                  <div id="notesError" class="d-none alert alert-danger"></div>
                </div>
              </div>
            </div>
            ` : ''}
            
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header bg-white d-flex align-items-center justify-content-between">
                  <strong>Appointments</strong>
                  ${userRole === 'RECEPTIONIST' ? `
                    <button class="btn btn-sm btn-primary" onclick="scheduleAppointment('${patient.id}')">Schedule New</button>
                  ` : ''}
                </div>
                <div class="card-body">
                  <div id="appointmentsLoading" class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading appointments...</p>
                  </div>
                  <div id="appointmentsList" class="d-none"></div>
                  <div id="appointmentsError" class="d-none alert alert-danger"></div>
                </div>
              </div>
            </div>
            ` : `
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header bg-white">
                  <strong>Access Restrictions</strong>
                </div>
                <div class="card-body">
                  <div class="restricted-field">
                    <i class="fas fa-lock me-2"></i>
                    <strong>Medical information is restricted to medical staff only.</strong>
                    <br>
                    <small>Your role (${userRole}) does not have permission to view medical data, diagnosis, or medications.</small>
                  </div>
                </div>
              </div>
            </div>
            `}

            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header bg-white d-flex align-items-center justify-content-between">
                  <strong>Encryption Info</strong>
                </div>
                <div class="card-body">
                  <div class="row gy-3">
                    <div class="col-12 col-md-4">
                      <div class="info-label"><span class="encryption-badge encryption-deterministic">D</span> Deterministic Encryption</div>
                      <small class="text-muted d-block mt-1">Exact match queries (equality). Used for fields like email and lastName that need to be searched.</small>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="info-label"><span class="encryption-badge encryption-range">R</span> Range Encryption</div>
                      <small class="text-muted d-block mt-1">Inequality and range queries. Used for date fields like birthDate to enable age-based queries.</small>
                    </div>
                    <div class="col-12 col-md-4">
                      <div class="info-label"><span class="encryption-badge encryption-standard">S</span> Standard Encryption</div>
                      <small class="text-muted d-block mt-1">Maximum security for highly sensitive fields like address, insurance number, conditions, and medications.</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header bg-white">
                  <strong>Role-Based Access Control (RBAC) - ${userRole} View</strong>
                </div>
                <div class="card-body">
                  ${generateRoleExplanation(userRole)}
                </div>
              </div>
            </div>
          </div>
        `;

        patientDetail.classList.remove('loading');
        patientDetail.innerHTML = html;
      }
      
      // Generate role-based access explanation
      function generateRoleExplanation(role) {
        let explanation = `
          <p class="card-text small mb-3">This system demonstrates HIPAA-compliant role-based access control using MongoDB Queryable Encryption:</p>
        `;
        
        switch(role) {
          case 'DOCTOR':
            explanation += `
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-success">✓ What you can see:</h6>
                  <ul class="small">
                    <li><strong>All patient data</strong> including SSN, medical history, medications</li>
                    <li><strong>Insurance information</strong> for billing purposes</li>
                    <li><strong>Full edit/delete permissions</strong> for patient records</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-info">Encryption types shown:</h6>
                  <ul class="small">
                    <li><span class="encryption-badge encryption-deterministic">D</span> Deterministic - Searchable fields</li>
                    <li><span class="encryption-badge encryption-range">R</span> Range - Date queries</li>
                    <li><span class="encryption-badge encryption-standard">S</span> Standard - Maximum security</li>
                  </ul>
                </div>
              </div>
            `;
            break;
          case 'NURSE':
            explanation += `
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-success">✓ What you can see:</h6>
                  <ul class="small">
                    <li><strong>Medical information</strong> (diagnosis, medications, allergies)</li>
                    <li><strong>Basic patient data</strong> (name, DOB, contact info)</li>
                    <li><strong>View-only access</strong> to patient records</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-danger">✗ What you cannot see:</h6>
                  <ul class="small">
                    <li><strong>SSN</strong> - Not needed for medical care</li>
                    <li><strong>Insurance details</strong> - Handled by reception</li>
                    <li><strong>Edit/Delete permissions</strong> - Doctor-only actions</li>
                  </ul>
                </div>
              </div>
            `;
            break;
          case 'RECEPTIONIST':
            explanation += `
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-success">✓ What you can see:</h6>
                  <ul class="small">
                    <li><strong>Insurance information</strong> for billing and scheduling</li>
                    <li><strong>Basic patient data</strong> (name, DOB, contact info)</li>
                    <li><strong>View-only access</strong> to patient records</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-danger">✗ What you cannot see:</h6>
                  <ul class="small">
                    <li><strong>Medical information</strong> - Not needed for scheduling</li>
                    <li><strong>SSN</strong> - Not needed for front desk operations</li>
                    <li><strong>Edit/Delete permissions</strong> - Doctor-only actions</li>
                  </ul>
                </div>
              </div>
            `;
            break;
          case 'ADMIN':
            explanation += `
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-success">✓ What you can see:</h6>
                  <ul class="small">
                    <li><strong>Basic patient data</strong> (name, DOB, contact info)</li>
                    <li><strong>Insurance information</strong> for administrative purposes</li>
                    <li><strong>Audit logs and system monitoring</strong></li>
                    <li><strong>User management capabilities</strong></li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-danger">✗ What you cannot see:</h6>
                  <ul class="small">
                    <li><strong>Medical information</strong> - Not needed for administration</li>
                    <li><strong>SSN</strong> - Not needed for administrative tasks</li>
                    <li><strong>Edit/Delete patient records</strong> - Medical staff only</li>
                  </ul>
                </div>
              </div>
            `;
            break;
        }
        
        explanation += `
          <div class="mt-3">
            <p class="small text-muted mb-0">
              <strong>Note:</strong> This demonstrates the "minimum necessary" rule of HIPAA - users only see the data they need for their job function. 
              All sensitive data is encrypted using MongoDB Queryable Encryption, ensuring even database administrators cannot access patient information.
            </p>
          </div>
        `;
        
        return explanation;
      }
      
      // Format date
      function formatDate(dateString) {
        if (!dateString) return '';
        
        try {
          // Handle YYYY-MM-DD format specifically to avoid timezone issues
          if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
            const [year, month, day] = dateString.split('-');
            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            return date.toLocaleDateString();
          }
          
          const date = new Date(dateString);
          if (isNaN(date.getTime())) {
            return dateString; // If not a valid date, return the original string
          }
          return date.toLocaleDateString();
        } catch (e) {
          console.error('Error formatting date:', e);
          return dateString;
        }
      }
      
      // Logout function (legacy - now handled by navbar)
      function handleLogout() {
        // Logout is now handled by the navbar
      }
      
      // Display status message
      function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = 'status ' + type;
        statusDiv.style.display = 'block';
      }
    });
    
    // Load patient appointments
    async function loadPatientAppointments(patientId) {
      const appointmentsLoading = document.getElementById('appointmentsLoading');
      const appointmentsList = document.getElementById('appointmentsList');
      const appointmentsError = document.getElementById('appointmentsError');
      
      try {
        // Fetch appointments for this patient using verification system
        const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/appointments/patient/${patientId}`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error(`Failed to load appointments: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Patient appointments:', data);
        
        // Hide loading indicator
        appointmentsLoading.classList.add('d-none');
        
        // Display appointments
        if (data.appointments && data.appointments.length > 0) {
          appointmentsList.classList.remove('d-none');
          
          // Sort appointments by date (most recent first)
          const sortedAppointments = [...data.appointments].sort((a, b) => {
            return new Date(b.scheduledAt) - new Date(a.scheduledAt);
          });
          
          // Format appointments as table
          let html = `
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Date & Time</th>
                    <th>Notes</th>
                    <th>Created By</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          sortedAppointments.forEach(appointment => {
            const appointmentDate = new Date(appointment.scheduledAt);
            const formattedDate = appointmentDate.toLocaleDateString();
            const formattedTime = appointmentDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            html += `
              <tr>
                <td>${formattedDate} at ${formattedTime}</td>
                <td>${appointment.notes || '<em>No notes</em>'}</td>
                <td>${appointment.createdBy}</td>
              </tr>
            `;
          });
          
          html += `
                </tbody>
              </table>
            </div>
          `;
          
          appointmentsList.innerHTML = html;
        } else {
          // No appointments
          appointmentsList.classList.remove('d-none');
          appointmentsList.innerHTML = `
            <div class="text-center py-3">
              <p class="text-muted">No appointments found for this patient.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading appointments:', error);
        appointmentsLoading.classList.add('d-none');
        appointmentsError.classList.remove('d-none');
        appointmentsError.textContent = error.message || 'Failed to load appointments';
      }
    }
    
    // Schedule new appointment (placeholder function)
    function scheduleAppointment(patientId) {
      alert(`This would open a modal to schedule an appointment for patient ${patientId}. Feature to be implemented.`);
    }
    
    // Delete patient function (in global scope for button handler)
    function deletePatient(id) {
      if (confirm(`Are you sure you want to delete this patient record? This action cannot be undone.`)) {
        alert(`Patient ${id} would be deleted in a real application`);
        window.location.href = '/patients.html';
      }
    }
  </script>

  <!-- Add Note Modal -->
  <div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addNoteModalLabel">Add Medical Note</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="addNoteAlert" class="alert d-none" role="alert"></div>
          <form id="addNoteForm">
            <div class="mb-3">
              <label for="noteContent" class="form-label">Note Content:</label>
              <textarea class="form-control" id="noteContent" rows="6" 
                        placeholder="Enter your medical note here..." required></textarea>
              <div class="form-text">This note will be encrypted and added to the patient's medical record.</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveNoteBtn">
            <i class="fas fa-save me-1"></i>Save Note
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Note Modal -->
  <div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editNoteModalLabel">Edit Medical Note</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="editNoteAlert" class="alert d-none" role="alert"></div>
          <form id="editNoteForm">
            <input type="hidden" id="editNoteId">
            <div class="mb-3">
              <label for="editNoteContent" class="form-label">Note Content:</label>
              <textarea class="form-control" id="editNoteContent" rows="6" required></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="updateNoteBtn">
            <i class="fas fa-save me-1"></i>Update Note
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI SOAP Note Modal -->
  <div class="modal fade" id="aiSoapModal" tabindex="-1" aria-labelledby="aiSoapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aiSoapModalLabel">
            <i class="fas fa-robot me-2"></i>AI SOAP Note Generation
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="aiSoapAlert" class="alert d-none" role="alert"></div>
          <form id="aiSoapForm">
            <div class="row">
              <div class="col-md-6">
                <label for="aiConversationText" class="form-label">Conversation/Interview Text</label>
                <textarea class="form-control" id="aiConversationText" rows="6" 
                          placeholder="Enter the patient conversation, interview notes, or clinical discussion..."></textarea>
              </div>
              <div class="col-md-6">
                <div class="row">
                  <div class="col-12 mb-3">
                    <label for="aiVitalSigns" class="form-label">Vital Signs</label>
                    <textarea class="form-control" id="aiVitalSigns" rows="3" 
                              placeholder="BP: 120/80, HR: 72, Temp: 98.6°F, RR: 16..."></textarea>
                  </div>
                  <div class="col-12">
                    <label for="aiPhysicalExam" class="form-label">Physical Examination</label>
                    <textarea class="form-control" id="aiPhysicalExam" rows="3" 
                              placeholder="Physical examination findings..."></textarea>
                  </div>
                </div>
              </div>
            </div>
          </form>
          <div id="aiSoapLoading" class="text-center py-4 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Generating SOAP note...</span>
            </div>
            <p class="mt-2 text-muted">AI is generating your SOAP note...</p>
          </div>
          <div id="aiSoapResult" class="d-none">
            <h6><i class="fas fa-file-medical me-2"></i>Generated SOAP Note</h6>
            <div id="aiSoapContent" class="border rounded p-3 bg-light"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="generateSoapBtn">
            <i class="fas fa-magic me-1"></i>Generate SOAP Note
          </button>
          <button type="button" class="btn btn-success d-none" id="saveSoapBtn">
            <i class="fas fa-save me-1"></i>Save to Patient Record
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Visit Summary Modal -->
  <div class="modal fade" id="aiSummaryModal" tabindex="-1" aria-labelledby="aiSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aiSummaryModalLabel">
            <i class="fas fa-robot me-2"></i>AI Visit Summary Generation
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="aiSummaryAlert" class="alert d-none" role="alert"></div>
          <form id="aiSummaryForm">
            <div class="row">
              <div class="col-md-8">
                <label for="aiRawNotes" class="form-label">Raw Notes</label>
                <textarea class="form-control" id="aiRawNotes" rows="4" 
                          placeholder="Enter raw clinical notes or visit details..."></textarea>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="aiDiagnosis" class="form-label">Diagnosis</label>
                  <textarea class="form-control" id="aiDiagnosis" rows="2" 
                            placeholder="Primary diagnosis..."></textarea>
                </div>
                <div class="mb-3">
                  <label for="aiMedications" class="form-label">Medications</label>
                  <textarea class="form-control" id="aiMedications" rows="2" 
                            placeholder="Current medications..."></textarea>
                </div>
              </div>
            </div>
          </form>
          <div id="aiSummaryLoading" class="text-center py-4 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Generating summary...</span>
            </div>
            <p class="mt-2 text-muted">AI is generating your visit summary...</p>
          </div>
          <div id="aiSummaryResult" class="d-none">
            <h6><i class="fas fa-file-alt me-2"></i>Generated Summary</h6>
            <div id="aiSummaryContent" class="border rounded p-3 bg-light"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="generateSummaryBtn">
            <i class="fas fa-compress-alt me-1"></i>Generate Summary
          </button>
          <button type="button" class="btn btn-success d-none" id="saveSummaryBtn">
            <i class="fas fa-save me-1"></i>Save to Patient Record
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Note Enhancement Modal -->
  <div class="modal fade" id="aiEnhancementModal" tabindex="-1" aria-labelledby="aiEnhancementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aiEnhancementModalLabel">
            <i class="fas fa-robot me-2"></i>AI Note Enhancement
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="aiEnhancementAlert" class="alert d-none" role="alert"></div>
          <form id="aiEnhancementForm">
            <div class="mb-3">
              <label for="aiExistingNotes" class="form-label">Existing Notes</label>
              <textarea class="form-control" id="aiExistingNotes" rows="6" 
                        placeholder="Enter existing clinical notes to enhance..."></textarea>
            </div>
          </form>
          <div id="aiEnhancementLoading" class="text-center py-4 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Enhancing notes...</span>
            </div>
            <p class="mt-2 text-muted">AI is enhancing your clinical notes...</p>
          </div>
          <div id="aiEnhancementResult" class="d-none">
            <h6><i class="fas fa-edit me-2"></i>Enhanced Notes</h6>
            <div id="aiEnhancementContent" class="border rounded p-3 bg-light"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="enhanceNotesBtn">
            <i class="fas fa-magic me-1"></i>Enhance Notes
          </button>
          <button type="button" class="btn btn-success d-none" id="saveEnhancementBtn">
            <i class="fas fa-save me-1"></i>Save to Patient Record
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI ICD Codes Modal -->
  <div class="modal fade" id="aiCodesModal" tabindex="-1" aria-labelledby="aiCodesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aiCodesModalLabel">
            <i class="fas fa-robot me-2"></i>AI ICD-10 Code Suggestions
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="aiCodesAlert" class="alert d-none" role="alert"></div>
          <form id="aiCodesForm">
            <div class="row">
              <div class="col-md-6">
                <label for="aiSymptoms" class="form-label">Symptoms</label>
                <textarea class="form-control" id="aiSymptoms" rows="4" 
                          placeholder="Enter patient symptoms (comma-separated)..."></textarea>
              </div>
              <div class="col-md-6">
                <label for="aiDiagnosisCodes" class="form-label">Diagnosis</label>
                <textarea class="form-control" id="aiDiagnosisCodes" rows="4" 
                          placeholder="Enter clinical diagnosis (comma-separated)..."></textarea>
              </div>
            </div>
          </form>
          <div id="aiCodesLoading" class="text-center py-4 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Analyzing...</span>
            </div>
            <p class="mt-2 text-muted">AI is analyzing symptoms and diagnosis...</p>
          </div>
          <div id="aiCodesResult" class="d-none">
            <h6><i class="fas fa-code me-2"></i>Suggested ICD-10 Codes</h6>
            <div id="aiCodesContent"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="suggestCodesBtn">
            <i class="fas fa-search me-1"></i>Suggest ICD Codes
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPatientId = null;
    let currentNotes = [];

    // Load patient notes
    async function loadPatientNotes(patientId) {
      currentPatientId = patientId;
      const notesLoading = document.getElementById('notesLoading');
      const notesList = document.getElementById('notesList');
      const notesError = document.getElementById('notesError');
      
      console.log('Loading patient notes for ID:', patientId);
      console.log('Patient verification available:', typeof window.patientVerification !== 'undefined');
      
      try {
        // Fetch notes using verification system
        const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/patients/${patientId}/notes`, {
          credentials: 'include'
        });
        
        console.log('Notes API response status:', response.status);
        
        if (!response.ok) {
          if (response.status === 403) {
            throw new Error('You do not have permission to view notes for this patient.');
          } else if (response.status === 404) {
            throw new Error('Patient not found.');
          }
          throw new Error(`Failed to load notes: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        currentNotes = data.notes || [];
        
        // Hide loading indicator
        notesLoading.classList.add('d-none');
        
        // Display notes
        displayNotes(currentNotes);
        
      } catch (error) {
        console.error('Error loading notes:', error);
        notesLoading.classList.add('d-none');
        notesError.classList.remove('d-none');
        notesError.textContent = error.message || 'Failed to load notes';
      }
    }

    // Display notes
    function displayNotes(notes) {
      const notesList = document.getElementById('notesList');
      
      if (notes.length === 0) {
        notesList.classList.remove('d-none');
        notesList.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-sticky-note fa-3x text-muted mb-3"></i>
            <p class="text-muted">No medical notes found for this patient.</p>
            <button class="btn btn-primary btn-sm" onclick="openAddNoteModal('${currentPatientId}')">
              <i class="fas fa-plus me-1"></i>Add First Note
            </button>
          </div>
        `;
        return;
      }

      // Sort notes by creation date (most recent first)
      const sortedNotes = [...notes].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      let html = `
        <div class="row">
      `;

      sortedNotes.forEach(note => {
        html += `
          <div class="col-12 mb-3">
            <div class="card border-left-primary">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-user-md text-primary me-2"></i>
                    <strong>Dr. ${escapeHtml(note.doctorName || 'Unknown')}</strong>
                  </div>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#" onclick="editNote('${note.id}')">
                        <i class="fas fa-edit me-2"></i>Edit
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" onclick="enhanceNoteWithAI('${note.id}', '${escapeHtml(note.content)}')">
                        <i class="fas fa-robot me-2"></i>Enhance with AI
                      </a></li>
                      <li><a class="dropdown-item" href="#" onclick="generateSoapFromNote('${note.id}', '${escapeHtml(note.content)}')">
                        <i class="fas fa-clipboard-list me-2"></i>Generate SOAP
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item text-danger" href="#" onclick="deleteNote('${note.id}')">
                        <i class="fas fa-trash me-2"></i>Delete
                      </a></li>
                    </ul>
                  </div>
                </div>
                <div class="note-content mb-2">${escapeHtml(note.content).replace(/\n/g, '<br>')}</div>
                <small class="text-muted">
                  <i class="fas fa-clock me-1"></i>
                  Created: ${new Date(note.createdAt).toLocaleString()}
                  ${note.updatedAt !== note.createdAt ? `
                    <span class="ms-3">
                      <i class="fas fa-edit me-1"></i>
                      Updated: ${new Date(note.updatedAt).toLocaleString()}
                    </span>
                  ` : ''}
                </small>
              </div>
            </div>
          </div>
        `;
      });

      html += `</div>`;
      notesList.classList.remove('d-none');
      notesList.innerHTML = html;
    }

    // Open add note modal
    function openAddNoteModal(patientId) {
      currentPatientId = patientId;
      document.getElementById('addNoteForm').reset();
      document.getElementById('addNoteAlert').classList.add('d-none');
      
      const modal = new bootstrap.Modal(document.getElementById('addNoteModal'));
      modal.show();
      
      // Focus on textarea
      setTimeout(() => {
        document.getElementById('noteContent').focus();
      }, 500);
    }

    // Save note
    document.getElementById('saveNoteBtn').addEventListener('click', async function() {
      const content = document.getElementById('noteContent').value.trim();
      const alertDiv = document.getElementById('addNoteAlert');
      
      if (!content) {
        showAlert(alertDiv, 'danger', 'Please enter note content.');
        return;
      }

      try {
        // Show loading state
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
        showAlert(alertDiv, 'info', 'Saving note...');

        console.log('Saving note for patient:', currentPatientId);
        console.log('Patient verification available:', typeof window.patientVerification !== 'undefined');

        const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/patients/${currentPatientId}/notes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ content })
        });
        
        console.log('Save note API response status:', response.status);

        if (!response.ok) {
          if (response.status === 403) {
            throw new Error('You do not have permission to add notes.');
          }
          throw new Error('Failed to add note');
        }

        showAlert(alertDiv, 'success', 'Note added successfully!');
        document.getElementById('addNoteForm').reset();
        
        // Reload notes
        await loadPatientNotes(currentPatientId);
        
        // Close modal after a short delay
        setTimeout(() => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('addNoteModal'));
          modal.hide();
        }, 1500);

      } catch (error) {
        console.error('Error adding note:', error);
        showAlert(alertDiv, 'danger', error.message || 'Failed to add note');
      } finally {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-save me-1"></i>Save Note';
      }
    });

    // Edit note
    function editNote(noteId) {
      const note = currentNotes.find(n => n.id === noteId);
      if (!note) return;

      document.getElementById('editNoteId').value = noteId;
      document.getElementById('editNoteContent').value = note.content;
      document.getElementById('editNoteAlert').classList.add('d-none');
      
      const modal = new bootstrap.Modal(document.getElementById('editNoteModal'));
      modal.show();
      
      // Focus on textarea
      setTimeout(() => {
        document.getElementById('editNoteContent').focus();
      }, 500);
    }

    // Update note
    document.getElementById('updateNoteBtn').addEventListener('click', async function() {
      const noteId = document.getElementById('editNoteId').value;
      const content = document.getElementById('editNoteContent').value.trim();
      const alertDiv = document.getElementById('editNoteAlert');
      
      if (!content) {
        showAlert(alertDiv, 'danger', 'Please enter note content.');
        return;
      }

      try {
        // Show loading state
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
        showAlert(alertDiv, 'info', 'Updating note...');

        const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/patients/${currentPatientId}/notes/${noteId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ content })
        });

        if (!response.ok) {
          if (response.status === 403) {
            throw new Error('You do not have permission to edit notes.');
          }
          throw new Error('Failed to update note');
        }

        showAlert(alertDiv, 'success', 'Note updated successfully!');
        
        // Reload notes
        await loadPatientNotes(currentPatientId);
        
        // Close modal after a short delay
        setTimeout(() => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('editNoteModal'));
          modal.hide();
        }, 1500);

      } catch (error) {
        console.error('Error updating note:', error);
        showAlert(alertDiv, 'danger', error.message || 'Failed to update note');
      } finally {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-save me-1"></i>Update Note';
      }
    });

    // Delete note
    function deleteNote(noteId) {
      if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
        return;
      }

      (async () => {
        try {
          const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/patients/${currentPatientId}/notes/${noteId}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (!response.ok) {
            if (response.status === 403) {
              throw new Error('You do not have permission to delete notes.');
            }
            throw new Error('Failed to delete note');
          }

          // Reload notes
          await loadPatientNotes(currentPatientId);
          
          // Show success message
          const notesList = document.getElementById('notesList');
          const successDiv = document.createElement('div');
          successDiv.className = 'alert alert-success alert-dismissible fade show';
          successDiv.innerHTML = `
            Note deleted successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          notesList.insertBefore(successDiv, notesList.firstChild);
          
          // Auto-dismiss after 3 seconds
          setTimeout(() => {
            successDiv.remove();
          }, 3000);

        } catch (error) {
          console.error('Error deleting note:', error);
          alert(error.message || 'Failed to delete note');
        }
      })();
    }

    // Helper function to show alerts
    function showAlert(alertDiv, type, message) {
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      alertDiv.classList.remove('d-none');
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // AI Modal Functions
    function openAISoapModal(patientId) {
      currentPatientId = patientId;
      document.getElementById('aiSoapForm').reset();
      document.getElementById('aiSoapAlert').classList.add('d-none');
      document.getElementById('aiSoapLoading').classList.add('d-none');
      document.getElementById('aiSoapResult').classList.add('d-none');
      document.getElementById('saveSoapBtn').classList.add('d-none');
      
      const modal = new bootstrap.Modal(document.getElementById('aiSoapModal'));
      modal.show();
      
      setTimeout(() => {
        document.getElementById('aiConversationText').focus();
      }, 500);
    }

    function openAISummaryModal(patientId) {
      currentPatientId = patientId;
      document.getElementById('aiSummaryForm').reset();
      document.getElementById('aiSummaryAlert').classList.add('d-none');
      document.getElementById('aiSummaryLoading').classList.add('d-none');
      document.getElementById('aiSummaryResult').classList.add('d-none');
      document.getElementById('saveSummaryBtn').classList.add('d-none');
      
      const modal = new bootstrap.Modal(document.getElementById('aiSummaryModal'));
      modal.show();
      
      setTimeout(() => {
        document.getElementById('aiRawNotes').focus();
      }, 500);
    }

    function openAIEnhancementModal(patientId) {
      currentPatientId = patientId;
      document.getElementById('aiEnhancementForm').reset();
      document.getElementById('aiEnhancementAlert').classList.add('d-none');
      document.getElementById('aiEnhancementLoading').classList.add('d-none');
      document.getElementById('aiEnhancementResult').classList.add('d-none');
      document.getElementById('saveEnhancementBtn').classList.add('d-none');
      
      const modal = new bootstrap.Modal(document.getElementById('aiEnhancementModal'));
      modal.show();
      
      setTimeout(() => {
        document.getElementById('aiExistingNotes').focus();
      }, 500);
    }

    function openAICodesModal(patientId) {
      currentPatientId = patientId;
      document.getElementById('aiCodesForm').reset();
      document.getElementById('aiCodesAlert').classList.add('d-none');
      document.getElementById('aiCodesLoading').classList.add('d-none');
      document.getElementById('aiCodesResult').classList.add('d-none');
      
      const modal = new bootstrap.Modal(document.getElementById('aiCodesModal'));
      modal.show();
      
      setTimeout(() => {
        document.getElementById('aiSymptoms').focus();
      }, 500);
    }

    // AI Functions for individual notes
    function enhanceNoteWithAI(noteId, noteContent) {
      currentPatientId = currentPatientId; // Ensure we have the patient ID
      document.getElementById('aiExistingNotes').value = noteContent;
      openAIEnhancementModal(currentPatientId);
    }

    function generateSoapFromNote(noteId, noteContent) {
      currentPatientId = currentPatientId; // Ensure we have the patient ID
      document.getElementById('aiConversationText').value = noteContent;
      openAISoapModal(currentPatientId);
    }

    // AI Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // SOAP Note Generation
      document.getElementById('generateSoapBtn').addEventListener('click', async function() {
        const conversationText = document.getElementById('aiConversationText').value.trim();
        if (!conversationText) {
          showAIAlert('aiSoapAlert', 'danger', 'Please enter conversation text');
          return;
        }

        const vitalSigns = document.getElementById('aiVitalSigns').value;
        const physicalExam = document.getElementById('aiPhysicalExam').value;

        try {
          showAILoading('aiSoapLoading');
          hideAIResult('aiSoapResult');

          const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/ai-documentation/soap-note/${currentPatientId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              conversationText: conversationText,
              vitalSigns: vitalSigns ? vitalSigns.split('\n') : [],
              physicalExam: physicalExam ? physicalExam.split('\n') : []
            })
          });

          const data = await response.json();

          if (data.success) {
            displayAISoapNote(data.data);
            document.getElementById('saveSoapBtn').classList.remove('d-none');
          } else {
            throw new Error(data.message);
          }

        } catch (error) {
          console.error('Error generating SOAP note:', error);
          showAIAlert('aiSoapAlert', 'danger', 'Failed to generate SOAP note: ' + error.message);
        } finally {
          hideAILoading('aiSoapLoading');
        }
      });

      // Visit Summary Generation
      document.getElementById('generateSummaryBtn').addEventListener('click', async function() {
        const rawNotes = document.getElementById('aiRawNotes').value.trim();
        if (!rawNotes) {
          showAIAlert('aiSummaryAlert', 'danger', 'Please enter raw notes');
          return;
        }

        const diagnosis = document.getElementById('aiDiagnosis').value;
        const medications = document.getElementById('aiMedications').value;

        try {
          showAILoading('aiSummaryLoading');
          hideAIResult('aiSummaryResult');

          const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/ai-documentation/visit-summary/${currentPatientId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              rawNotes: rawNotes,
              diagnosis: diagnosis ? diagnosis.split(',').map(d => d.trim()) : [],
              medications: medications ? medications.split(',').map(m => m.trim()) : []
            })
          });

          const data = await response.json();

          if (data.success) {
            displayAISummary(data.data);
            document.getElementById('saveSummaryBtn').classList.remove('d-none');
          } else {
            throw new Error(data.message);
          }

        } catch (error) {
          console.error('Error generating visit summary:', error);
          showAIAlert('aiSummaryAlert', 'danger', 'Failed to generate visit summary: ' + error.message);
        } finally {
          hideAILoading('aiSummaryLoading');
        }
      });

      // Note Enhancement
      document.getElementById('enhanceNotesBtn').addEventListener('click', async function() {
        const existingNotes = document.getElementById('aiExistingNotes').value.trim();
        if (!existingNotes) {
          showAIAlert('aiEnhancementAlert', 'danger', 'Please enter existing notes');
          return;
        }

        try {
          showAILoading('aiEnhancementLoading');
          hideAIResult('aiEnhancementResult');

          const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/ai-documentation/enhance-notes/${currentPatientId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              existingNotes: existingNotes,
              context: {}
            })
          });

          const data = await response.json();

          if (data.success) {
            displayAIEnhancement(data.data);
            document.getElementById('saveEnhancementBtn').classList.remove('d-none');
          } else {
            throw new Error(data.message);
          }

        } catch (error) {
          console.error('Error enhancing notes:', error);
          showAIAlert('aiEnhancementAlert', 'danger', 'Failed to enhance notes: ' + error.message);
        } finally {
          hideAILoading('aiEnhancementLoading');
        }
      });

      // ICD Code Suggestions
      document.getElementById('suggestCodesBtn').addEventListener('click', async function() {
        const symptoms = document.getElementById('aiSymptoms').value;
        const diagnosis = document.getElementById('aiDiagnosisCodes').value;

        if (!symptoms.trim() && !diagnosis.trim()) {
          showAIAlert('aiCodesAlert', 'danger', 'Please enter symptoms or diagnosis');
          return;
        }

        try {
          showAILoading('aiCodesLoading');
          hideAIResult('aiCodesResult');

          const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/ai-documentation/icd-codes`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              symptoms: symptoms ? symptoms.split(',').map(s => s.trim()) : [],
              diagnosis: diagnosis ? diagnosis.split(',').map(d => d.trim()) : [],
              patientData: {}
            })
          });

          const data = await response.json();

          if (data.success) {
            displayAICodes(data.data.icdCodes);
          } else {
            throw new Error(data.message);
          }

        } catch (error) {
          console.error('Error suggesting ICD codes:', error);
          showAIAlert('aiCodesAlert', 'danger', 'Failed to suggest ICD codes: ' + error.message);
        } finally {
          hideAILoading('aiCodesLoading');
        }
      });

      // Save AI Notes
      document.getElementById('saveSoapBtn').addEventListener('click', () => saveAINote('soap'));
      document.getElementById('saveSummaryBtn').addEventListener('click', () => saveAINote('summary'));
      document.getElementById('saveEnhancementBtn').addEventListener('click', () => saveAINote('enhancement'));
    });

    // AI Display Functions
    function displayAISoapNote(soapNote) {
      const soapContent = document.getElementById('aiSoapContent');
      
      let confidenceClass = 'badge bg-warning';
      if (soapNote.confidence_score >= 0.8) confidenceClass = 'badge bg-success';
      else if (soapNote.confidence_score >= 0.6) confidenceClass = 'badge bg-warning';
      else confidenceClass = 'badge bg-danger';

      soapContent.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6>SOAP Note</h6>
          <span class="${confidenceClass}">
            Confidence: ${Math.round(soapNote.confidence_score * 100)}%
          </span>
        </div>
        
        <div class="mb-3">
          <h6 class="text-primary"><i class="fas fa-user me-2"></i>SUBJECTIVE</h6>
          <p class="mb-0">${soapNote.subjective || 'No subjective information provided'}</p>
        </div>
        
        <div class="mb-3">
          <h6 class="text-primary"><i class="fas fa-stethoscope me-2"></i>OBJECTIVE</h6>
          <p class="mb-0">${soapNote.objective || 'No objective findings provided'}</p>
        </div>
        
        <div class="mb-3">
          <h6 class="text-primary"><i class="fas fa-brain me-2"></i>ASSESSMENT</h6>
          <p class="mb-0">${soapNote.assessment || 'No assessment provided'}</p>
        </div>
        
        <div class="mb-3">
          <h6 class="text-primary"><i class="fas fa-clipboard-check me-2"></i>PLAN</h6>
          <p class="mb-0">${soapNote.plan || 'No plan provided'}</p>
        </div>
        
        ${soapNote.suggestions && soapNote.suggestions.length > 0 ? `
          <div class="mt-3">
            <h6 class="text-info"><i class="fas fa-lightbulb me-2"></i>Suggestions</h6>
            <ul class="mb-0">
              ${soapNote.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
      `;
      
      showAIResult('aiSoapResult');
    }

    function displayAISummary(summaryData) {
      const summaryContent = document.getElementById('aiSummaryContent');
      
      summaryContent.innerHTML = `
        <div class="alert alert-success">
          <h6><i class="fas fa-file-alt me-2"></i>Generated Summary</h6>
          <p class="mb-0">${summaryData.summary}</p>
        </div>
        <div class="text-muted small">
          <i class="fas fa-user-md me-1"></i>Generated by: ${summaryData.generatedBy}<br>
          <i class="fas fa-clock me-1"></i>Generated at: ${new Date(summaryData.generatedAt).toLocaleString()}
        </div>
      `;
      
      showAIResult('aiSummaryResult');
    }

    function displayAIEnhancement(enhancedData) {
      const enhancementContent = document.getElementById('aiEnhancementContent');
      
      let confidenceClass = 'badge bg-danger';
      if (enhancedData.confidence >= 0.8) confidenceClass = 'badge bg-success';
      else if (enhancedData.confidence >= 0.6) confidenceClass = 'badge bg-warning';

      enhancementContent.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6>Enhanced Notes</h6>
          <span class="${confidenceClass}">
            Confidence: ${Math.round(enhancedData.confidence * 100)}%
          </span>
        </div>
        
        <div class="alert alert-success">
          <h6><i class="fas fa-edit me-2"></i>Enhanced Version</h6>
          <p class="mb-0">${enhancedData.enhanced_notes}</p>
        </div>
        
        ${enhancedData.suggestions && enhancedData.suggestions.length > 0 ? `
          <div class="mt-3">
            <h6 class="text-info"><i class="fas fa-lightbulb me-2"></i>Suggestions</h6>
            <ul class="mb-0">
              ${enhancedData.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
        
        ${enhancedData.areas_for_improvement && enhancedData.areas_for_improvement.length > 0 ? `
          <div class="mt-3">
            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement</h6>
            <ul class="mb-0">
              ${enhancedData.areas_for_improvement.map(area => `<li>${area}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
      `;
      
      showAIResult('aiEnhancementResult');
    }

    function displayAICodes(icdCodes) {
      const icdContent = document.getElementById('aiCodesContent');
      
      icdContent.innerHTML = icdCodes.map(code => `
        <div class="card mb-2">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <span class="badge bg-primary me-2">${code.code}</span>
                <span class="badge bg-${code.category === 'Primary' ? 'success' : code.category === 'Secondary' ? 'info' : 'secondary'}">
                  ${code.category}
                </span>
              </div>
              <span class="badge bg-${code.confidence >= 0.8 ? 'success' : code.confidence >= 0.6 ? 'warning' : 'danger'}">
                ${Math.round(code.confidence * 100)}%
              </span>
            </div>
            <p class="mb-1 mt-2">${code.description}</p>
            <small class="text-muted">${code.rationale}</small>
          </div>
        </div>
      `).join('');
      
      showAIResult('aiCodesResult');
    }

    // AI Utility Functions
    function showAILoading(elementId) {
      document.getElementById(elementId).classList.remove('d-none');
    }

    function hideAILoading(elementId) {
      document.getElementById(elementId).classList.add('d-none');
    }

    function showAIResult(elementId) {
      document.getElementById(elementId).classList.remove('d-none');
    }

    function hideAIResult(elementId) {
      document.getElementById(elementId).classList.add('d-none');
    }

    function showAIAlert(alertId, type, message) {
      const alertDiv = document.getElementById(alertId);
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      alertDiv.classList.remove('d-none');
    }

    // Save AI Note to Patient Record
    async function saveAINote(type) {
      if (!currentPatientId) {
        showAIAlert('aiSoapAlert', 'warning', 'No patient selected');
        return;
      }

      let content = '';
      let aiType = '';
      let confidenceScore = 0.0;
      let metadata = {};

      // Get content based on type
      switch (type) {
        case 'soap':
          const soapContent = document.getElementById('aiSoapContent');
          if (!soapContent.innerHTML.trim()) {
            showAIAlert('aiSoapAlert', 'warning', 'No SOAP note to save');
            return;
          }
          content = soapContent.innerText;
          aiType = 'soap_note';
          confidenceScore = 0.8;
          metadata = { type: 'SOAP Note Generation' };
          break;
        case 'summary':
          const summaryContent = document.getElementById('aiSummaryContent');
          if (!summaryContent.innerHTML.trim()) {
            showAIAlert('aiSummaryAlert', 'warning', 'No visit summary to save');
            return;
          }
          content = summaryContent.innerText;
          aiType = 'visit_summary';
          confidenceScore = 0.8;
          metadata = { type: 'Visit Summary Generation' };
          break;
        case 'enhancement':
          const enhancementContent = document.getElementById('aiEnhancementContent');
          if (!enhancementContent.innerHTML.trim()) {
            showAIAlert('aiEnhancementAlert', 'warning', 'No enhanced notes to save');
            return;
          }
          content = enhancementContent.innerText;
          aiType = 'enhanced_notes';
          confidenceScore = 0.7;
          metadata = { type: 'Note Enhancement' };
          break;
        default:
          showAIAlert('aiSoapAlert', 'error', 'Unknown AI note type');
          return;
      }

      try {
        const response = await window.patientVerification.fetchWithVerification(`${window.location.origin}/api/ai-documentation/save-note/${currentPatientId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            content: content,
            aiType: aiType,
            confidenceScore: confidenceScore,
            metadata: metadata
          })
        });

        const data = await response.json();

        if (data.success) {
          showAIAlert('aiSoapAlert', 'success', 'AI-generated note saved to patient record successfully!');
          
          // Reload notes to show the new AI note
          await loadPatientNotes(currentPatientId);
          
          // Close modal after a short delay
          setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('aiSoapModal'));
            if (modal) modal.hide();
          }, 2000);
        } else {
          throw new Error(data.message);
        }

      } catch (error) {
        console.error('Error saving AI note:', error);
        showAIAlert('aiSoapAlert', 'danger', 'Failed to save AI note: ' + error.message);
      }
    }
  </script>
</body>
</html>