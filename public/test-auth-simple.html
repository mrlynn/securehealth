<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Test - SecureHealth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Authentication Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Login Test</h3>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" value="doctor@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" value="doctor">
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
                <div id="loginResult" class="mt-3"></div>
            </div>
            
            <div class="col-md-6">
                <h3>Auth Status</h3>
                <button onclick="checkAuth()" class="btn btn-info">Check Auth Status</button>
                <div id="authResult" class="mt-3"></div>
                
                <h3 class="mt-4">Medical Knowledge Test</h3>
                <button onclick="testMedicalKnowledge()" class="btn btn-success">Test Medical Knowledge Access</button>
                <div id="medicalResult" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const result = document.getElementById('loginResult');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<div class="alert alert-success">✅ Login successful!<br>User: ${data.user.username}<br>Roles: ${data.user.roles.join(', ')}</div>`;
                    // Store in localStorage for consistency
                    localStorage.setItem('securehealth_user', JSON.stringify(data.user));
                } else {
                    result.innerHTML = `<div class="alert alert-danger">❌ Login failed: ${data.message}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="alert alert-danger">❌ Error: ${error.message}</div>`;
            }
        });
        
        async function checkAuth() {
            const result = document.getElementById('authResult');
            
            // Check localStorage
            const userData = localStorage.getItem('securehealth_user');
            let html = '<h5>localStorage:</h5>';
            if (userData) {
                const user = JSON.parse(userData);
                html += `<div class="alert alert-info">✅ User in localStorage:<br>${user.username} (${user.roles.join(', ')})</div>`;
            } else {
                html += `<div class="alert alert-warning">❌ No user in localStorage</div>`;
            }
            
            // Check session via API
            html += '<h5>Session API:</h5>';
            try {
                const response = await fetch('/api/user', {
                    credentials: 'include',
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        html += `<div class="alert alert-success">✅ Session valid:<br>${data.user.username} (${data.user.roles.join(', ')})</div>`;
                    } else {
                        html += `<div class="alert alert-warning">❌ Session API failed: ${data.message}</div>`;
                    }
                } else {
                    html += `<div class="alert alert-danger">❌ Session API returned ${response.status}</div>`;
                }
            } catch (error) {
                html += `<div class="alert alert-danger">❌ Session API error: ${error.message}</div>`;
            }
            
            result.innerHTML = html;
        }
        
        async function testMedicalKnowledge() {
            const result = document.getElementById('medicalResult');
            
            try {
                const response = await fetch('/api/medical-knowledge/stats', {
                    credentials: 'include',
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `<div class="alert alert-success">✅ Medical Knowledge API accessible!<br>Response: ${JSON.stringify(data, null, 2)}</div>`;
                } else {
                    result.innerHTML = `<div class="alert alert-danger">❌ Medical Knowledge API returned ${response.status}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="alert alert-danger">❌ Medical Knowledge API error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
