<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Patient - SecureHealth</title>
  <style>
    /* Page-specific styles - navbar styles moved to shared CSS */
    body {
      background-color: #f8f9fa; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 80px;
    }
    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
    }
    /* Role badge and navbar styles moved to shared navbar.css */
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .page-title {
      font-size: 24px;
      margin: 0;
    }
    .form-actions {
      display: flex;
    }
    .btn {
      background-color: #0d6efd;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
      text-decoration: none;
      font-size: 16px;
    }
    .btn-secondary {
      background-color: #6c757d;
    }
    .btn:hover {
      opacity: 0.9;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 15px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    .back-link {
      color: #0d6efd;
      display: inline-flex;
      align-items: center;
      margin-bottom: 20px;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    .tab-nav {
      display: flex;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom: 2px solid #0d6efd;
      color: #0d6efd;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .encryption-badge {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 5px;
      vertical-align: middle;
    }
    .encryption-deterministic {
      background-color: #0dcaf0;
      color: #055160;
    }
    .encryption-range {
      background-color: #20c997;
      color: #0f5132;
    }
    .encryption-standard {
      background-color: #6f42c1;
      color: white;
    }
    .status {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      display: none;
    }
    .error {
      background-color: #f8d7da;
      color: #842029;
    }
    .success {
      background-color: #d1e7dd;
      color: #0f5132;
    }
    .section-title {
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 10px;
      margin: 30px 0 20px;
      color: #495057;
    }
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .tag {
      background-color: #e9ecef;
      padding: 5px 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
    }
    .tag-remove {
      margin-left: 5px;
      cursor: pointer;
      color: #dc3545;
    }
    .tag-input {
      display: flex;
      margin-top: 10px;
    }
    .tag-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      margin-right: 10px;
    }
    .tag-input button {
      padding: 8px 15px;
      background-color: #0d6efd;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .home-link {
      display: inline-block;
      margin: 0 20px;
      color: white;
      text-decoration: none;
    }
    .home-link:hover {
      text-decoration: underline;
    }
    .notes-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 15px;
      background-color: #f8f9fa;
    }
    .note-item {
      background-color: white;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .note-item:last-child {
      margin-bottom: 0;
    }
    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e9ecef;
    }
    .note-date {
      color: #6c757d;
      font-size: 0.9em;
    }
    .note-content {
      color: #495057;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .note-updated {
      color: #6c757d;
      font-size: 0.8em;
      margin-top: 8px;
      font-style: italic;
    }
    .add-note-section {
      border-top: 1px solid #dee2e6;
      padding-top: 15px;
    }
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    .btn-outline-danger {
      color: #dc3545;
      border-color: #dc3545;
    }
    .btn-outline-danger:hover {
      background-color: #dc3545;
      color: white;
    }
  </style>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
  <!-- Shared navbar styles -->
  <link href="/assets/css/navbar.css" rel="stylesheet">
  <!-- Role-aware navbar script -->
  <script src="/assets/js/navbar.js"></script>
  <!-- Patient verification script -->
  <script src="/assets/js/patient-verification.js?v=3"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</head>
<body>
  <!-- Role-aware navbar will be inserted here -->
  <div id="navbar-container"></div>

  <div class="container">
    <a href="javascript:history.back()" class="back-link">
      ← Back
    </a>
    
    <div id="status" class="status"></div>
    
    <div id="patientForm" class="loading">
      Loading patient data...
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const patientForm = document.getElementById('patientForm');
      const statusDiv = document.getElementById('status');
      
      // Patient data to edit
      let patientData = {};
      
      // Wait for navbar to initialize, then check authentication
      setTimeout(() => {
        checkAuth();
      }, 100);
      
      // Get patient ID from URL
      const params = new URLSearchParams(window.location.search);
      const patientId = params.get('id');
      
      if (!patientId) {
        showStatus('No patient ID provided', 'error');
        patientForm.innerHTML = '<p>Error: No patient ID provided</p>';
        return;
      }
      
      // Load patient data
      loadPatientData(patientId);
      
      // Check if user is authenticated
      function checkAuth() {
        // Get user from navbar
        const user = window.secureHealthNavbar.getCurrentUser();
        
        if (!user) {
          console.log("No user found, redirecting to login");
          window.location.href = '/login.html';
          return;
        }
        
        console.log("User data from navbar:", user);
      }
      
      // Load patient data
      async function loadPatientData(id) {
        console.log("Loading patient data for ID:", id);
        
        try {
          // Use the verification system to handle patient data loading
          const response = await window.patientVerification.fetchWithVerification(`/api/patients/${id}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include'
          });
          
          if (!response.ok) {
            if (response.status === 404) {
              throw new Error("Patient not found");
            } else if (response.status === 401) {
              throw new Error("Authentication required");
            } else if (response.status === 403) {
              throw new Error("Access denied");
            } else {
              throw new Error(`Server error: ${response.status}`);
            }
          }
          
          const patient = await response.json();
          console.log("Patient data loaded:", patient);
          console.log("Patient birthDate:", patient.birthDate, typeof patient.birthDate);
          
          // Set global patient data
          patientData = patient;
          
          // Render patient form
          renderPatientForm(patient);
        } catch (error) {
          console.error("Error loading patient:", error);
          showStatus('Error loading patient data', 'error');
          patientForm.innerHTML = `<p>Error: ${error.message || 'Failed to load patient'}</p>`;
        }
      }
      
      // Render patient form
      function renderPatientForm(patient) {
        const html = `
          <div class="card">
            <div class="form-header">
              <h2 class="page-title">Edit Patient: ${patient.firstName} ${patient.lastName}</h2>
            </div>
            
            <div class="tab-nav">
              <div class="tab active" data-tab="basic-info">Basic Info</div>
              <div class="tab" data-tab="medical-info">Medical Info</div>
            </div>
            
            <form id="editPatientForm" onsubmit="return false;">
              <div id="basic-info" class="tab-content active">
                <div class="form-row">
                  <div class="form-group">
                    <label for="firstName">First Name <span class="encryption-badge encryption-deterministic">D</span></label>
                    <input type="text" id="firstName" class="form-control" value="${patient.firstName}" required>
                  </div>
                  <div class="form-group">
                    <label for="lastName">Last Name <span class="encryption-badge encryption-deterministic">D</span></label>
                    <input type="text" id="lastName" class="form-control" value="${patient.lastName}" required>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="birthDate">Date of Birth <span class="encryption-badge encryption-range">R</span></label>
                    <input type="date" id="birthDate" class="form-control" value="${formatDateForInput(patient.birthDate)}" required>
                  </div>
                  <div class="form-group">
                    <label for="email">Email <span class="encryption-badge encryption-deterministic">D</span></label>
                    <input type="email" id="email" class="form-control" value="${patient.email}" required>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="tel" id="phone" class="form-control" value="${patient.phoneNumber || ''}" required>
                  </div>
                  <div class="form-group">
                    <label for="address">Address <span class="encryption-badge encryption-standard">S</span></label>
                    <input type="text" id="address" class="form-control" value="${patient.address || ''}" required>
                  </div>
                </div>
              </div>
              
              <div id="medical-info" class="tab-content">
                <div class="form-row">
                  <div class="form-group">
                    <label for="insuranceProvider">Insurance Provider</label>
                    <input type="text" id="insuranceProvider" class="form-control" value="${patient.insuranceDetails?.provider || ''}">
                  </div>
                  <div class="form-group">
                    <label for="insuranceNumber">Insurance Number <span class="encryption-badge encryption-standard">S</span></label>
                    <input type="text" id="insuranceNumber" class="form-control" value="${patient.insuranceDetails?.policyNumber || ''}">
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Allergies</label>
                  <div id="allergiesList" class="tag-list">
                    ${(patient.allergies || []).map(allergy => 
                      `<div class="tag">${allergy} <span class="tag-remove" onclick="removeItem('allergies', '${allergy}')">✕</span></div>`
                    ).join('')}
                  </div>
                  <div class="tag-input">
                    <input type="text" id="allergyInput" class="form-control" placeholder="Add allergy...">
                    <button type="button" onclick="addItem('allergies')">Add</button>
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Conditions <span class="encryption-badge encryption-standard">S</span></label>
                  <div id="conditionsList" class="tag-list">
                    ${(patient.diagnosis || []).map(condition => 
                      `<div class="tag">${condition} <span class="tag-remove" onclick="removeItem('diagnosis', '${condition}')">✕</span></div>`
                    ).join('')}
                  </div>
                  <div class="tag-input">
                    <input type="text" id="conditionInput" class="form-control" placeholder="Add condition...">
                    <button type="button" onclick="addItem('diagnosis')">Add</button>
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Medications <span class="encryption-badge encryption-standard">S</span></label>
                  <div id="medicationsList" class="tag-list">
                    ${(patient.medications || []).map(medication => 
                      `<div class="tag">${medication} <span class="tag-remove" onclick="removeItem('medications', '${medication}')">✕</span></div>`
                    ).join('')}
                  </div>
                  <div class="tag-input">
                    <input type="text" id="medicationInput" class="form-control" placeholder="Add medication...">
                    <button type="button" onclick="addItem('medications')">Add</button>
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Medical Notes <span class="encryption-badge encryption-standard">S</span></label>
                  <div id="notesList" class="notes-container">
                    ${(patient.notesHistory || []).map(note => `
                      <div class="note-item">
                        <div class="note-header">
                          <strong>${note.doctorName || 'Unknown Doctor'}</strong>
                          <span class="note-date">${formatNoteDate(note.createdAt)}</span>
                          <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteNote('${note.id}')" title="Delete note">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                        <div class="note-content">${escapeHtml(note.content)}</div>
                        ${note.updatedAt && note.updatedAt !== note.createdAt ? 
                          `<div class="note-updated">Last updated: ${formatNoteDate(note.updatedAt)}</div>` : ''
                        }
                      </div>
                    `).join('')}
                  </div>
                  <div class="add-note-section">
                    <textarea id="newNote" class="form-control" rows="4" placeholder="Add a new medical note..."></textarea>
                    <button type="button" class="btn btn-primary" onclick="addNote()" style="margin-top: 10px;">
                      <i class="fas fa-plus"></i> Add Note
                    </button>
                  </div>
                  <small class="form-text text-muted">These notes are strongly encrypted and only accessible to authorized medical staff.</small>
                </div>
              </div>
              
              <div class="form-actions" style="margin-top: 30px;">
                <a href="javascript:history.back()" class="btn btn-secondary">Cancel</a>
                <button type="button" onclick="savePatient()" class="btn">Save Changes</button>
              </div>
            </form>
          </div>
        `;
        
        patientForm.innerHTML = html;
        
        // Add tab switching functionality
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', function() {
            // Get the tab id
            const tabId = this.getAttribute('data-tab');
            
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
          });
        });
      }
      
      // Format date for HTML date input (YYYY-MM-DD)
      function formatDateForInput(dateString) {
        if (!dateString) return '';
        
        try {
          // Handle YYYY-MM-DD format specifically to avoid timezone issues
          if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
            return dateString; // Already in correct format
          }
          
          const date = new Date(dateString);
          if (isNaN(date.getTime())) {
            return dateString; // If not a valid date, return the original string
          }
          
          // Use UTC methods to avoid timezone issues
          const year = date.getUTCFullYear();
          const month = String(date.getUTCMonth() + 1).padStart(2, '0');
          const day = String(date.getUTCDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        } catch (e) {
          console.error('Error formatting date for input:', e);
          return dateString;
        }
      }
      
      // Format date for note display
      function formatNoteDate(dateString) {
        if (!dateString) return 'Unknown date';
        
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        } catch (e) {
          return dateString;
        }
      }
      
      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // Logout function (legacy - now handled by navbar)
      function handleLogout() {
        // Logout is now handled by the navbar
        // This function is kept for compatibility
      }
      
      // Display status message
      function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = 'status ' + type;
        statusDiv.style.display = 'block';
        
        // Auto-hide success messages after 3 seconds
        if (type === 'success') {
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 3000);
        }
      }
      
      // Make functions available globally
      window.patientData = patientData;
      window.showStatus = showStatus;
      window.formatNoteDate = formatNoteDate;
      window.escapeHtml = escapeHtml;
      window.loadPatientData = loadPatientData;
    });
    
    // Add item to a list (allergies, conditions, medications)
    function addItem(listType) {
      const inputElement = document.getElementById(`${listType}Input`);
      const listElement = document.getElementById(`${listType}List`);
      const value = inputElement.value.trim();
      
      if (value) {
        // Add to list
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.innerHTML = `${value} <span class="tag-remove" onclick="removeItem('${listType}', '${value}')">✕</span>`;
        listElement.appendChild(tag);
        
        // Add to patient data - handle diagnosis field mapping
        const dataField = listType === 'conditionInput' ? 'diagnosis' : listType.replace('Input', '');
        if (!window.patientData[dataField]) {
          window.patientData[dataField] = [];
        }
        if (!window.patientData[dataField].includes(value)) {
          window.patientData[dataField].push(value);
        }
        
        // Clear input
        inputElement.value = '';
      }
    }
    
    // Remove item from a list
    function removeItem(listType, value) {
      // Handle diagnosis field mapping
      const dataField = listType === 'diagnosis' ? 'diagnosis' : listType;
      
      // Remove from patient data
      if (window.patientData[dataField]) {
        window.patientData[dataField] = window.patientData[dataField].filter(item => item !== value);
      }
      
      // Redraw list
      const listElement = document.getElementById(`${listType}List`);
      if (listElement && window.patientData[dataField]) {
        listElement.innerHTML = window.patientData[dataField].map(item => 
          `<div class="tag">${item} <span class="tag-remove" onclick="removeItem('${listType}', '${item}')">✕</span></div>`
        ).join('');
      }
    }
    
    // Save patient data
    async function savePatient() {
      try {
        // Get form values
        const form = document.getElementById('editPatientForm');
        
        // Update patient data
        const updatedData = {
          firstName: document.getElementById('firstName').value,
          lastName: document.getElementById('lastName').value,
          birthDate: document.getElementById('birthDate').value,
          email: document.getElementById('email').value,
          phoneNumber: document.getElementById('phone').value,
          address: document.getElementById('address').value,
          insuranceDetails: {
            provider: document.getElementById('insuranceProvider').value,
            policyNumber: document.getElementById('insuranceNumber').value,
            groupNumber: window.patientData.insuranceDetails?.groupNumber || ''
          },
          allergies: window.patientData.allergies || [],
          diagnosis: window.patientData.diagnosis || [],
          medications: window.patientData.medications || []
        };
        
        console.log("Saving patient data:", updatedData);
        
        const response = await window.patientVerification.fetchWithVerification(`/api/patients/${window.patientData.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(updatedData)
        }, 'edit');
        
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error("Authentication required");
          } else if (response.status === 403) {
            throw new Error("Access denied");
          } else if (response.status === 404) {
            throw new Error("Patient not found");
          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `Server error: ${response.status}`);
          }
        }
        
        const result = await response.json();
        console.log("Patient updated successfully:", result);
        
        // Show success message
        window.showStatus('Patient information updated successfully!', 'success');
        
        // After a short delay, redirect back to the patient detail page
        setTimeout(() => {
          window.location.href = `/patient-detail.html?id=${window.patientData.id}`;
        }, 1500);
        
      } catch (error) {
        console.error("Error saving patient:", error);
        window.showStatus(`Error saving patient: ${error.message}`, 'error');
      }
    }
    
    // Add a new medical note
    async function addNote() {
      const noteTextarea = document.getElementById('newNote');
      const content = noteTextarea.value.trim();
      
      if (!content) {
        window.showStatus('Please enter a note before adding', 'error');
        return;
      }
      
      try {
        // Get current user info
        const user = window.secureHealthNavbar.getCurrentUser();
        if (!user) {
          throw new Error('User not authenticated');
        }
        
        const noteData = {
          content: content,
          doctorId: user.id || user.userIdentifier,
          doctorName: user.fullName || user.username || user.email
        };
        
        console.log("Adding note:", noteData);
        
        const response = await window.patientVerification.fetchWithVerification(`/api/patients/${window.patientData.id}/notes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(noteData)
        }, 'add_note');
        
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error("Authentication required");
          } else if (response.status === 403) {
            throw new Error("Access denied - only doctors can add notes");
          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `Server error: ${response.status}`);
          }
        }
        
        const result = await response.json();
        console.log("Note added successfully:", result);
        
        // Clear the textarea
        noteTextarea.value = '';
        
        // Reload patient data to show the new note
        await loadPatientData(window.patientData.id);
        
        window.showStatus('Note added successfully!', 'success');
        
      } catch (error) {
        console.error("Error adding note:", error);
        window.showStatus(`Error adding note: ${error.message}`, 'error');
      }
    }
    
    // Delete a medical note
    async function deleteNote(noteId) {
      if (!confirm('Are you sure you want to delete this note?')) {
        return;
      }
      
      try {
        console.log("Deleting note:", noteId);
        
        const response = await window.patientVerification.fetchWithVerification(`/api/patients/${window.patientData.id}/notes/${noteId}`, {
          method: 'DELETE',
          credentials: 'include'
        }, 'delete_note');
        
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error("Authentication required");
          } else if (response.status === 403) {
            throw new Error("Access denied - only doctors can delete notes");
          } else if (response.status === 404) {
            throw new Error("Note not found");
          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `Server error: ${response.status}`);
          }
        }
        
        console.log("Note deleted successfully");
        
        // Reload patient data to reflect the deletion
        await loadPatientData(window.patientData.id);
        
        window.showStatus('Note deleted successfully!', 'success');
        
      } catch (error) {
        console.error("Error deleting note:", error);
        window.showStatus(`Error deleting note: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>