<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - SecureHealth</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Shared navbar styles -->
  <link href="/assets/css/navbar.css" rel="stylesheet">
  <!-- Role-aware navbar script -->
  <script src="/assets/js/navbar.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  
  <style>
    :root {
      --mongodb-green: #00ED64;
      --mongodb-dark-green: #13AA52;
      --mongodb-black: #001E2B;
      --mongodb-gray: #6B7280;
      --mongodb-light-gray: #F7FAFC;
      --mongodb-white: #FFFFFF;
      --mongodb-border: #E5E7EB;
    }
    
    /* Page-specific styles - navbar styles moved to shared CSS */
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--mongodb-light-gray);
      background-image: linear-gradient(135deg, rgba(0, 237, 100, 0.05) 0%, rgba(19, 170, 82, 0.1) 100%);
    }
    
    .login-container {
      min-height: calc(100vh - 80px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1000px;
      margin: 0 20px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .login-header h1 {
      color: var(--mongodb-black);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .login-header p {
      color: var(--mongodb-gray);
      max-width: 600px;
      margin: 0 auto;
    }

    .login-panels {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .login-form-panel {
      flex: 1;
      min-width: 300px;
      background-color: var(--mongodb-white);
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      padding: 30px;
      border-top: 4px solid var(--mongodb-green);
      border: 1px solid var(--mongodb-border);
    }

    .quick-access-panel {
      flex: 1;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .access-card {
      background-color: var(--mongodb-white);
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      padding: 20px;
      transition: all 0.2s ease;
      border: 1px solid var(--mongodb-border);
    }

    .access-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .test-accounts-card {
      border-top: 4px solid var(--mongodb-green);
    }

    .patient-portal-card {
      border-top: 4px solid var(--mongodb-dark-green);
      text-align: center;
    }

    h2 {
      font-size: 1.5rem;
      color: var(--mongodb-black);
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--mongodb-black);
    }

    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--mongodb-border);
      border-radius: 8px;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
      background: var(--mongodb-white);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--mongodb-green);
      box-shadow: 0 0 0 3px rgba(0, 237, 100, 0.25);
    }

    .login-button {
      width: 100%;
      padding: 0.75rem;
      background-color: var(--mongodb-green);
      color: var(--mongodb-black);
      border: 1px solid var(--mongodb-green);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s ease;
      margin-top: 0.5rem;
    }

    .login-button:hover {
      background-color: var(--mongodb-dark-green);
      border-color: var(--mongodb-dark-green);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 237, 100, 0.3);
    }

    .alert {
      padding: 12px;
      margin-bottom: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .role-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
    }

    .role-btn {
      display: flex;
      align-items: center;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
      padding: 16px 12px;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .role-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .role-btn:hover::before {
      left: 100%;
    }

    .role-btn.doctor {
      background: linear-gradient(135deg, var(--mongodb-green), var(--mongodb-dark-green));
      color: var(--mongodb-black);
    }

    .role-btn.nurse {
      background: linear-gradient(135deg, var(--mongodb-dark-green), #0d9488);
      color: white;
    }

    .role-btn.receptionist {
      background: linear-gradient(135deg, #0d9488, #0891b2);
      color: white;
    }

    .role-btn.admin {
      background: linear-gradient(135deg, var(--mongodb-black), #374151);
      color: white;
    }

    .role-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 237, 100, 0.3);
    }

    .role-btn.doctor:hover {
      box-shadow: 0 8px 20px rgba(0, 237, 100, 0.4);
    }

    .role-btn.nurse:hover {
      box-shadow: 0 8px 20px rgba(19, 170, 82, 0.4);
    }

    .role-btn.receptionist:hover {
      box-shadow: 0 8px 20px rgba(13, 148, 136, 0.4);
    }

    .role-btn.admin:hover {
      box-shadow: 0 8px 20px rgba(0, 30, 43, 0.4);
    }

    .role-icon {
      font-size: 1.8rem;
      margin-bottom: 4px;
    }

    .portal-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: linear-gradient(135deg, var(--mongodb-dark-green), #0d9488);
      color: white;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      margin-top: 0.5rem;
      position: relative;
      overflow: hidden;
    }

    .portal-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .portal-button:hover::before {
      left: 100%;
    }

    .portal-button:hover {
      background: linear-gradient(135deg, #0d9488, #0891b2);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(19, 170, 82, 0.3);
      color: white;
    }

    .resources-footer {
      display: flex;
      justify-content: center;
      margin-top: 2rem;
    }

    .resources-footer a {
      color: #6c757d;
      margin: 0 1rem;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .resources-footer a:hover {
      color: var(--mongodb-green);
    }

    @media (max-width: 768px) {
      .login-panels {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Role-aware navbar will be inserted here -->
  <div id="navbar-container"></div>

  <div class="login-container">
    <div class="login-wrapper">
      <div class="login-header">
        <h1><img src="/images/securehealth-logo.png" alt="SecureHealth Logo" height="60" class="me-2">SecureHealth Platform</h1>
        <p>Secure, HIPAA-compliant healthcare information management with MongoDB Queryable Encryption</p>
      </div>
      
      <div class="login-panels">
        <!-- Professional Login Form -->
        <div class="login-form-panel">
          <h2><i class="fas fa-user-md me-2"></i>Healthcare Staff Login</h2>
          
          <div id="alert" style="display: none;" class="alert"></div>
          
          <div class="form-group">
            <label class="form-label" for="email">Email Address</label>
            <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="password">Password</label>
            <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
          </div>
          
          <button id="loginBtn" class="login-button">
            <i class="fas fa-sign-in-alt me-2"></i>Login to Dashboard
          </button>
        </div>
        
        <!-- Quick Access Panel -->
        <div class="quick-access-panel">
          <!-- Test Accounts Card -->
          <div class="access-card test-accounts-card">
            <h2><i class="fas fa-users me-2"></i>Quick Access</h2>
            <p>Select a role to quickly access the demo:</p>
            
            <div class="role-grid">
              <button class="role-btn doctor" data-email="doctor@example.com" data-password="doctor">
                <i class="role-icon fas fa-user-md"></i> Doctor
              </button>
              <button class="role-btn nurse" data-email="nurse@example.com" data-password="nurse">
                <i class="role-icon fas fa-user-nurse"></i> Nurse
              </button>
              <button class="role-btn receptionist" data-email="receptionist@example.com" data-password="receptionist">
                <i class="role-icon fas fa-user-tie"></i> Receptionist
              </button>
              <button class="role-btn admin" data-email="admin@securehealth.com" data-password="admin123">
                <i class="role-icon fas fa-cog"></i> Admin
              </button>
            </div>
          </div>
          
          <!-- Patient Portal Card -->
          <div class="access-card patient-portal-card">
            <h2><i class="fas fa-hospital-user me-2"></i>Patient Portal</h2>
            <p>Access your medical records, appointments, and communicate with your healthcare providers securely.</p>
            <a href="/patient-portal/index.html" class="portal-button">
              <i class="fas fa-user-circle me-1"></i>Access Patient Portal
            </a>
          </div>
        </div>
      </div>
      
      <!-- Resources Footer -->
      <div class="resources-footer">
        <a href="/visitor-router.html"><i class="fas fa-route me-1"></i>Find Your Path</a>
        <a href="/home.html"><i class="fas fa-rocket me-1"></i>Overview</a>
        <a href="/documentation.html" target="_blank"><i class="fas fa-book me-1"></i>Documentation</a>
        <a href="/queryable-encryption-search.html"><i class="fas fa-search me-1"></i>Encryption Demo</a>
      </div>
    </div>
  </div>
  
  <script>
    // Debug helper function
    function debugLog(msg, data) {
      console.log("🔍 " + msg, data);
      // You can also show debug info on the page if needed
    }
    
    // Check if we were redirected back here
    window.addEventListener('load', function() {
      debugLog("Page loaded", { 
        url: window.location.href, 
        referrer: document.referrer,
        localStorage: localStorage.getItem('securehealth_user')
      });
      
      // If we have user data but still ended up here, redirect to dashboard
      const userData = localStorage.getItem('securehealth_user');
      if (userData) {
        console.log("WARNING: Already logged in but back at login page! Redirecting to dashboard...", JSON.parse(userData));
        // Redirect to dashboard instead of staying on login page
        window.location.href = 'dashboard.html';
        return;
      }
      
      // Add click handlers to role buttons
      document.querySelectorAll('.role-btn').forEach(button => {
        button.addEventListener('click', function() {
          const email = this.getAttribute('data-email');
          const password = this.getAttribute('data-password');
          
          // Fill in the form
          document.getElementById('email').value = email;
          document.getElementById('password').value = password;
          
          // Submit the form
          document.getElementById('loginBtn').click();
        });
      });
    });
    
    document.getElementById('loginBtn').addEventListener('click', function() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const alertEl = document.getElementById('alert');
      
      if (!email || !password) {
        alertEl.className = 'alert alert-danger';
        alertEl.textContent = 'Please enter email and password';
        alertEl.style.display = 'block';
        return;
      }
      
      // API login
      alertEl.className = 'alert alert-info';
      alertEl.textContent = 'Authenticating...';
      alertEl.style.display = 'block';
      
      debugLog("Attempting login", { email });
      
      // Call the login API endpoint
      fetch('/api/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          _username: email,
          _password: password
        })
      })
      .then(response => {
        debugLog("API response received", { 
          status: response.status, 
          statusText: response.statusText 
        });
        return response.json();
      })
      .then(data => {
        debugLog("API response data", data);
        
        if (data.success) {
          // Login successful - use the complete user object from the API response
          const user = data.user || {
            email: email,
            username: data.username || email,
            roles: data.roles || [],
            isAdmin: data.isAdmin || false
          };
          
          debugLog("Created user object", user);
          
          // Store user data in localStorage
          localStorage.setItem('securehealth_user', JSON.stringify(user));
          debugLog("Saved to localStorage", localStorage.getItem('securehealth_user'));
          
          // Verify it was saved
          const verification = localStorage.getItem('securehealth_user');
          if (!verification) {
            console.error("❌ FAILED to save to localStorage!");
            alertEl.className = 'alert alert-danger';
            alertEl.textContent = 'Error: Could not save session. Please try again.';
            return;
          }
          debugLog("✅ Verified localStorage has data");
          
          alertEl.className = 'alert alert-success';
          alertEl.textContent = 'Login successful! Redirecting...';
          
          // Determine redirect based on user role
          debugLog("Will redirect in 0.5 seconds");
          setTimeout(function() {
            debugLog("About to redirect, localStorage:", localStorage.getItem('securehealth_user'));
            // Redirect patients to patient portal, everyone else to main dashboard
            if (user.roles && (user.roles.includes('ROLE_PATIENT') || user.isPatient)) {
              debugLog("Redirecting to patient portal");
              window.location.href = 'patient-portal';
            } else {
              debugLog("Redirecting to patients dashboard");
              window.location.href = 'dashboard.html';
            }
          }, 500);
        } else {
          // Login failed
          alertEl.className = 'alert alert-danger';
          alertEl.textContent = data.message || data.error || 'Invalid credentials';
          alertEl.style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alertEl.className = 'alert alert-danger';
        alertEl.textContent = 'Authentication error. Please try again.';
        alertEl.style.display = 'block';
      });
    });
  </script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>